---
phase: 02-connection-file-sync
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - commands/connect/COMMAND.md
  - sites.json.example
  - .sites/.gitkeep
  - CLAUDE.md
autonomous: true

must_haves:
  truths:
    - "User can invoke /connect and be guided through SSH connection conversationally"
    - "SSH connectivity is verified before proceeding with any file operations"
    - "WordPress installation is auto-detected on the remote server"
    - "WP-CLI is detected and version checked, with install offer if missing"
    - "Files sync from remote to local with proper exclusions and size warnings"
    - "Successful connections are auto-saved to sites.json"
    - "One-off connections work without saving a profile"
  artifacts:
    - path: "commands/connect/COMMAND.md"
      provides: "Full connection flow prompt for Claude to follow"
      min_lines: 150
    - path: "sites.json.example"
      provides: "Updated schema showing all profile fields"
      contains: "last_sync"
    - path: ".sites/.gitkeep"
      provides: "Local sync directory placeholder"
    - path: "CLAUDE.md"
      provides: "Updated hot cache and safe operation patterns"
      contains: "Currently Connected Site"
  key_links:
    - from: "commands/connect/COMMAND.md"
      to: "sites.json"
      via: "jq commands for atomic profile save"
      pattern: "jq.*sites\\.json"
    - from: "commands/connect/COMMAND.md"
      to: ".sites/{site-name}/"
      via: "rsync destination path"
      pattern: "\\.sites/"
    - from: "commands/connect/COMMAND.md"
      to: "CLAUDE.md"
      via: "hot cache update after connection"
      pattern: "Hot Cache"
---

<objective>
Create the /connect command — the core connection workflow that guides users through SSH setup, WordPress detection, WP-CLI discovery, file sync, and automatic profile saving. This is the primary entry point for the plugin.

Purpose: Users need a single, conversational command that handles the entire connection-to-sync pipeline without manual steps.
Output: commands/connect/COMMAND.md (the prompt), updated sites.json.example (schema), .sites/.gitkeep (sync dir), updated CLAUDE.md (hot cache + patterns)
</objective>

<execution_context>
@/Users/robertli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robertli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-connection-file-sync/02-RESEARCH.md
@.planning/phases/02-connection-file-sync/02-CONTEXT.md
@CLAUDE.md
@sites.json.example
@.gitignore
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create /connect command prompt</name>
  <files>commands/connect/COMMAND.md</files>
  <action>
Create commands/connect/COMMAND.md — a markdown prompt that instructs Claude how to execute the full connection flow. This is NOT a bash script; it is a conversational workflow prompt that Claude follows step by step.

The COMMAND.md must include these sections in order:

**1. Command metadata (YAML frontmatter):**
- name: connect
- description: Connect to a WordPress site via SSH, sync files, and save profile
- usage: /connect [site-name] (optional — if provided, loads saved profile)

**2. Saved profile shortcut:**
- If user provides a site name argument, look up the profile in sites.json
- If found, skip SSH gathering — use saved details directly
- Skip SSH verification for saved profiles (per user decision)
- Jump straight to WordPress validation + sync
- If not found, tell user and fall through to new connection flow

**3. SSH detail gathering (conversational, one at a time per user decision):**
- Ask for hostname/IP (or SSH config alias)
- Check if hostname matches an SSH config alias by running: `ssh -G {hostname} 2>/dev/null | grep "^hostname "` — if the resolved hostname differs from input, show the user the matched config details (hostname, user, port, identity file) from `ssh -G` output
- Ask for SSH user (suggest the user from ssh -G if alias matched, or default to current username)
- Ask for SSH key path (suggest from ssh -G if available, or default to ~/.ssh/id_rsa; accept "default" to use SSH agent)
- Ask for remote WordPress path (but note: will auto-detect first)

**4. SSH connection verification (CONN-08):**
- Run: `ssh -o BatchMode=yes -o ConnectTimeout=10 -o StrictHostKeyChecking=accept-new {user}@{host} "echo 'connected'" 2>&1`
- On success: proceed
- On failure: diagnose the error from output and exit code:
  - "Connection timed out" -> host unreachable or firewall
  - "Connection refused" -> SSH daemon not running or wrong port
  - "Permission denied" -> wrong key or user
  - "UNPROTECTED PRIVATE KEY FILE" -> key permissions too open, suggest chmod 600
  - "Host key verification failed" -> host key changed, explain implications
- Suggest specific fixes for each error type
- Do NOT retry automatically — let user fix and re-run /connect

**5. WordPress path detection (auto-detect per user decision):**
- Search common paths via SSH: `/var/www/html`, `/home/{user}/public_html`, `/usr/share/nginx/html`, `/srv/www`, `~/www`, `~/public_html`, `~/htdocs`
- For each path, check: `ssh {user}@{host} "test -f {path}/wp-config.php" 2>/dev/null`
- If found, validate it's a real WordPress installation: check for wp-config.php AND wp-content/ AND wp-includes/ AND wp-load.php
- If multiple found, list them and ask user to choose
- If none found, ask user to provide the path manually
- Store the validated path for all subsequent operations

**6. WP-CLI detection (CONN-07):**
- Run: `ssh {user}@{host} "which wp" 2>/dev/null`
- If not in PATH, check common locations: /usr/local/bin/wp, ~/bin/wp, ~/.local/bin/wp, /usr/bin/wp
- If found: run `ssh {user}@{host} "{wp_cli_path} --version"` and parse version number
- If version < 2.10: warn that it's outdated but continue
- If not found: inform user WP-CLI is not installed, offer to install it:
  - Show the curl install command: `curl -O https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar && chmod +x wp-cli.phar`
  - Check if user has sudo: `ssh {user}@{host} "sudo -n true" 2>/dev/null`
  - If sudo: offer `sudo mv wp-cli.phar /usr/local/bin/wp`
  - If no sudo: offer `mkdir -p ~/bin && mv wp-cli.phar ~/bin/wp`
  - If user declines installation, continue without WP-CLI (note in profile that wp_cli_path is null)

**7. WP-CLI auto-gather (per user decision):**
- Only if WP-CLI was found/installed
- Run these commands over SSH (all with `cd {wp_path} &&`):
  - `wp core version` -> WordPress version
  - `wp option get siteurl` -> site URL
  - `wp plugin list --format=csv --fields=name,status,version` -> plugin summary
  - `wp theme list --status=active --field=name` -> active theme
- Display a concise summary to user: "WordPress X.X at {url}, {N} plugins, theme: {name}"
- Store gathered data for profile saving

**8. File sync with size check (SYNC-01 through SYNC-05):**
- First, check remote size: `ssh {user}@{host} "du -sb {wp_path} 2>/dev/null | cut -f1"`
- Convert to MB and display
- If over 500MB: warn user with the size and ask whether to proceed
- Detect rsync variant for macOS compatibility (SYNC-05):
  - Run `rsync --version 2>&1 | head -1`
  - If contains "openrsync" (macOS default): note that --info=progress2 is NOT supported, use -v instead
  - If contains "rsync version 3" (GNU/Homebrew): use --info=progress2 for progress
- Create local directory: `.sites/{site-name}/` (mkdir -p)
- Execute rsync with exclusions:
  ```
  rsync -avz \
    [--info=progress2 if GNU rsync, or -v if openrsync] \
    --exclude='wp-content/uploads/' \
    --exclude='wp-content/cache/' \
    --exclude='wp-content/w3tc-cache/' \
    --exclude='node_modules/' \
    --exclude='vendor/' \
    --exclude='.git/' \
    --exclude='.env' \
    --chmod=Du=rwx,Dgo=rx,Fu=rw,Fgo=r \
    {user}@{host}:{wp_path}/ .sites/{site-name}/
  ```
- Note: Do NOT exclude log files (per user decision — useful for diagnostics)
- Note: NEVER use --delete flag (safety pattern from CLAUDE.md)
- On success: report file count and size
- On failure: report rsync error and suggest troubleshooting

**9. Auto-save profile to sites.json (per user decision):**
- Generate site name from domain: extract domain from site_url (or hostname), replace dots with dashes (example.com -> example-com)
- If sites.json doesn't exist, create it with: `echo '{"sites":{}}' > sites.json`
- Use jq for atomic update (write to temp, validate, mv):
  ```
  jq --arg name "{site-name}" \
     --arg host "{host}" \
     --arg user "{user}" \
     --arg key "{key_path_or_null}" \
     --arg wp_path "{wp_path}" \
     --arg wp_version "{version_or_null}" \
     --arg site_url "{url_or_null}" \
     --arg wp_cli "{wp_cli_path_or_null}" \
     --arg local_path ".sites/{site-name}" \
     --arg timestamp "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
     '.sites[$name] = {
         "host": $host,
         "user": $user,
         "ssh_key": $key,
         "wp_path": $wp_path,
         "local_path": $local_path,
         "wp_version": $wp_version,
         "site_url": $site_url,
         "wp_cli_path": $wp_cli,
         "last_sync": $timestamp,
         "created_at": (.sites[$name].created_at // $timestamp),
         "environment": null,
         "is_default": (if (.sites | length) == 0 then true else (.sites[$name].is_default // false) end),
         "notes": null
     }' sites.json > /tmp/sites.json.tmp
  ```
- Validate: `jq empty /tmp/sites.json.tmp`
- If valid: `mv /tmp/sites.json.tmp sites.json`
- If this is the first site saved, automatically set it as default
- Tell user: "Profile saved as '{site-name}'. Use `/connect {site-name}` to reconnect."

**10. One-off connection mode (CONN-02):**
- If user explicitly says "don't save" or "one-off" during the flow, skip step 9
- Still perform all other steps (connect, detect, sync)
- Inform user: "Connection not saved. Files synced to .sites/{site-name}/ but no profile created."

**11. Update CLAUDE.md hot cache:**
- After successful connection, instruct Claude to mentally update the "Currently Connected Site" section in CLAUDE.md with: site name, host, WP version, WP-CLI status, local path, last sync time
- This is a mental model update, not a file write — the hot cache is populated in Claude's context

**12. Error handling throughout:**
- Every SSH command should have a 2>&1 redirect and exit code check
- If any step fails, explain what went wrong and what the user can do
- Never leave the user without a next action

The tone should be instructional — telling Claude exactly what commands to run and what to say to the user at each step. Use bash code blocks for commands. Be explicit about error handling.
  </action>
  <verify>
- File exists at commands/connect/COMMAND.md
- File has YAML frontmatter with name, description, usage
- File contains sections for: SSH gathering, connection testing, WordPress detection, WP-CLI detection, file sync, profile saving
- File references all required bash commands: ssh -o BatchMode=yes, ssh -G, rsync -avz, jq, du -sb, which wp
- File mentions exclusions: wp-content/uploads/, wp-content/cache/, node_modules/, vendor/
- File mentions: auto-save, one-off mode, size warning, openrsync compatibility
- File length is 150+ lines
  </verify>
  <done>
commands/connect/COMMAND.md exists with complete connection flow covering all CONN and SYNC requirements. A different Claude instance could follow this prompt to connect to a WordPress site without asking clarifying questions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update sites.json schema, create .sites dir, update CLAUDE.md</name>
  <files>sites.json.example, .sites/.gitkeep, CLAUDE.md</files>
  <action>
Three small updates to support the /connect command:

**A. Update sites.json.example** to reflect the full profile schema from user decisions:

Replace the current array-based format with the new object-keyed format:
```json
{
  "sites": {
    "example-com": {
      "host": "example.com",
      "user": "wpuser",
      "ssh_key": "~/.ssh/prod-key",
      "wp_path": "/var/www/html",
      "local_path": ".sites/example-com",
      "wp_version": "6.4.3",
      "site_url": "https://example.com",
      "wp_cli_path": "/usr/local/bin/wp",
      "last_sync": "2026-02-16T12:00:00Z",
      "created_at": "2026-02-16T10:00:00Z",
      "environment": "production",
      "is_default": true,
      "notes": "Main production site"
    },
    "staging-example-com": {
      "host": "staging.example.com",
      "user": "deployer",
      "ssh_key": null,
      "wp_path": "/home/deployer/public_html",
      "local_path": ".sites/staging-example-com",
      "wp_version": "6.4.3",
      "site_url": "https://staging.example.com",
      "wp_cli_path": "/usr/local/bin/wp",
      "last_sync": "2026-02-16T11:00:00Z",
      "created_at": "2026-02-15T09:00:00Z",
      "environment": "staging",
      "is_default": false,
      "notes": "Staging mirror of production"
    }
  }
}
```

Key changes from current format:
- Object keyed by site name (not array) for O(1) lookup with jq
- Added: local_path, wp_version, site_url, wp_cli_path, last_sync, created_at, environment, is_default, notes
- ssh_key can be null (uses SSH agent default)
- Removed: wp_url renamed to site_url, description renamed to notes
- Only one site can have is_default: true

**B. Create .sites/.gitkeep:**
- Create the `.sites/` directory with an empty `.gitkeep` file
- This directory is already in .gitignore so synced files won't be committed
- The .gitkeep ensures the directory structure exists in the repo

**C. Update CLAUDE.md:**

1. In the "Safe Operation Patterns" section, update the rsync exclusions list to match the /connect command's actual exclusions:
   - wp-content/uploads/
   - wp-content/cache/
   - wp-content/w3tc-cache/
   - node_modules/
   - vendor/
   - .git/
   - .env
   - Remove wp-config.php from exclusions (it's useful for diagnostics per the new approach)
   - Remove *.log from exclusions (per user decision: log files are NOT excluded)

2. Add a note about macOS openrsync compatibility: "macOS default rsync (openrsync) does not support --info=progress2; use -v flag instead. Check with `rsync --version`."

3. In the "Hot Cache" section, update the "Currently Connected Site" block to show the fields that /connect will populate:
   ```
   ### Currently Connected Site

   **Status:** Not connected

   <!-- Populated by /connect command -->
   <!-- Fields: name, host, user, wp_path, local_path, wp_version, site_url, wp_cli_path, last_sync -->
   ```

4. Do NOT add new sections or expand the file significantly. Keep CLAUDE.md lean per Phase 1 design.
  </action>
  <verify>
- sites.json.example contains object-keyed format with "sites" top-level key
- sites.json.example contains fields: host, user, ssh_key, wp_path, local_path, wp_version, site_url, wp_cli_path, last_sync, created_at, environment, is_default, notes
- .sites/.gitkeep exists
- CLAUDE.md safe operation patterns no longer exclude wp-config.php or *.log
- CLAUDE.md mentions openrsync compatibility
- CLAUDE.md hot cache section lists connection fields
  </verify>
  <done>
sites.json.example reflects full profile schema with all user-decided fields. .sites/ directory exists for synced files. CLAUDE.md safe patterns and hot cache are aligned with /connect command behavior.
  </done>
</task>

</tasks>

<verification>
Phase-level checks after both tasks complete:

1. `cat commands/connect/COMMAND.md | head -5` shows YAML frontmatter
2. `wc -l commands/connect/COMMAND.md` shows 150+ lines
3. `cat sites.json.example | jq .` parses successfully with new schema
4. `test -f .sites/.gitkeep && echo "exists"` confirms sync directory
5. `grep "openrsync" CLAUDE.md` confirms macOS compatibility note
6. `grep "wp-config.php" CLAUDE.md` does NOT appear in exclusions list
7. Cross-reference: every requirement ID (CONN-01 through CONN-08, SYNC-01 through SYNC-05) is addressed by a section in commands/connect/COMMAND.md
</verification>

<success_criteria>
- commands/connect/COMMAND.md is a complete, followable prompt that another Claude instance can execute to connect to a WordPress site via SSH, detect WordPress + WP-CLI, sync files, and save a profile
- sites.json.example demonstrates the full profile schema
- CLAUDE.md safe patterns align with actual /connect behavior
- All CONN and SYNC requirements are addressed in the connect command
</success_criteria>

<output>
After completion, create `.planning/phases/02-connection-file-sync/02-01-SUMMARY.md`
</output>
