---
phase: 02-connection-file-sync
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - commands/status/COMMAND.md
  - .claude-plugin/plugin.json
autonomous: true

must_haves:
  truths:
    - "User can list all saved site profiles with connection details"
    - "User can see last sync time and WordPress version for each site"
    - "User can identify which site is the default"
    - "User can remove a saved site profile"
    - "User can set a different site as the default"
    - "User can rename a site profile"
  artifacts:
    - path: "commands/status/COMMAND.md"
      provides: "Status display and profile management prompt"
      min_lines: 80
    - path: ".claude-plugin/plugin.json"
      provides: "Updated plugin manifest with command descriptions"
      contains: "commands"
  key_links:
    - from: "commands/status/COMMAND.md"
      to: "sites.json"
      via: "jq read for listing profiles"
      pattern: "jq.*sites\\.json"
    - from: "commands/status/COMMAND.md"
      to: "commands/connect/COMMAND.md"
      via: "references /connect for reconnection"
      pattern: "/connect"
---

<objective>
Create the /status command for site profile management and status display, plus update the plugin manifest. Users need to view their connected sites, manage profiles (remove, rename, set default), and see sync state at a glance.

Purpose: Profile management completes the connection lifecycle — users can review, organize, and clean up their site connections.
Output: commands/status/COMMAND.md, updated .claude-plugin/plugin.json
</objective>

<execution_context>
@/Users/robertli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robertli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-connection-file-sync/02-CONTEXT.md
@.planning/phases/02-connection-file-sync/02-01-SUMMARY.md
@commands/connect/COMMAND.md
@sites.json.example
@.claude-plugin/plugin.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create /status command prompt</name>
  <files>commands/status/COMMAND.md</files>
  <action>
Create commands/status/COMMAND.md — a markdown prompt that instructs Claude how to display site status and manage profiles. This covers CONN-04 (list profiles), CONN-05 (remove profiles), and the default site / rename features from user decisions.

The COMMAND.md must include:

**1. Command metadata (YAML frontmatter):**
- name: status
- description: View connected sites, sync status, and manage site profiles
- usage: /status [subcommand] — subcommands: (none), remove, default, rename

**2. Default behavior (no subcommand) — List all sites (CONN-04):**
- Check if sites.json exists. If not: "No sites connected yet. Use /connect to add your first site."
- Read sites.json with jq: `jq -r '.sites | to_entries[] | ...'`
- Display each site in a clear format:

```
## Connected Sites

### {site-name} {DEFAULT_MARKER}
- **Host:** {user}@{host}
- **WordPress:** {wp_version} at {site_url}
- **WP-CLI:** {wp_cli_path or "Not available"}
- **Last sync:** {last_sync} ({relative time like "2 hours ago"})
- **Local files:** {local_path}
- **Environment:** {environment or "Not set"}
- **Notes:** {notes or "None"}
```

- DEFAULT_MARKER: show "[DEFAULT]" next to the default site
- If no sites exist, suggest /connect
- Show count: "{N} site(s) connected"

**3. Remove a site profile (CONN-05):**
- Triggered by: /status remove {site-name}
- Verify the site exists in sites.json
- Ask for confirmation: "Remove profile '{site-name}'? This won't delete synced files in {local_path}. (yes/no)"
- If confirmed, use jq to remove: `jq 'del(.sites["{site-name}"])' sites.json > /tmp/sites.json.tmp && mv /tmp/sites.json.tmp sites.json`
- If the removed site was the default, warn: "Removed default site. Use `/status default {name}` to set a new default."
- Optionally offer to delete local files: "Delete synced files at {local_path}? (yes/no)" — use `rm -rf {local_path}` only if user confirms

**4. Set default site:**
- Triggered by: /status default {site-name}
- Verify the site exists in sites.json
- Use jq to set is_default: first set all sites to false, then set the specified one to true:
  ```
  jq --arg name "{site-name}" \
     '(.sites | to_entries | map(.value.is_default = false) | from_entries) as $reset |
      .sites = $reset | .sites[$name].is_default = true' sites.json > /tmp/sites.json.tmp
  ```
- Validate and mv atomically
- Confirm: "'{site-name}' is now the default site."

**5. Rename a site profile:**
- Triggered by: /status rename {old-name} {new-name}
- Verify old-name exists, new-name doesn't exist
- Use jq to rename the key: `jq --arg old "{old}" --arg new "{new}" '.sites[$new] = .sites[$old] | del(.sites[$old])' sites.json`
- If the site has a local_path matching the old name pattern, offer to rename the directory too: `mv .sites/{old-name} .sites/{new-name}`
- Update local_path in the profile if directory was renamed
- Atomic write via temp file

**6. Quick reconnect hint:**
- At the bottom of status output, always show: "Reconnect: `/connect {default-site-name}`" if a default is set

The tone should be instructional for Claude — exact jq commands, exact output format, exact error messages. Use bash code blocks for all commands.
  </action>
  <verify>
- File exists at commands/status/COMMAND.md
- File has YAML frontmatter with name, description, usage
- File contains sections for: list sites, remove site, set default, rename
- File references jq commands for reading and modifying sites.json
- File handles edge cases: no sites.json, empty sites, removing default site
- File length is 80+ lines
  </verify>
  <done>
commands/status/COMMAND.md exists with complete profile management covering list, remove, default, and rename operations. A different Claude instance can follow this prompt to display site status and manage profiles.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update plugin.json with command registrations</name>
  <files>.claude-plugin/plugin.json</files>
  <action>
Update .claude-plugin/plugin.json to include command descriptions that help Claude (and users) understand what each command does. Add a "commands" section listing all four commands (connect, status, diagnose, audit) with their current implementation status.

Updated plugin.json:
```json
{
  "name": "wordpress-expert",
  "version": "1.1.0",
  "description": "Expert WordPress diagnostics: security audits, performance analysis, code quality review, and plugin conflict resolution for site reliability.",
  "author": {
    "name": "Robert Li"
  },
  "commands": {
    "connect": {
      "description": "Connect to a WordPress site via SSH, detect WP-CLI, sync files, and save profile",
      "status": "implemented"
    },
    "status": {
      "description": "View connected sites, sync status, and manage site profiles (list, remove, default, rename)",
      "status": "implemented"
    },
    "diagnose": {
      "description": "Run full diagnostic suite on a connected WordPress site",
      "status": "placeholder"
    },
    "audit": {
      "description": "Run focused security audit on a connected WordPress site",
      "status": "placeholder"
    }
  }
}
```

Bump version from 1.0.0 to 1.1.0 to reflect Phase 2 additions.
  </action>
  <verify>
- .claude-plugin/plugin.json is valid JSON (parse with jq)
- Contains "commands" key with connect, status, diagnose, audit entries
- connect and status have status: "implemented"
- diagnose and audit have status: "placeholder"
- Version is "1.1.0"
  </verify>
  <done>
plugin.json reflects the current state of all commands with proper descriptions and implementation status.
  </done>
</task>

</tasks>

<verification>
Phase-level checks after both tasks complete:

1. `cat commands/status/COMMAND.md | head -5` shows YAML frontmatter
2. `wc -l commands/status/COMMAND.md` shows 80+ lines
3. `jq . .claude-plugin/plugin.json` parses successfully
4. `jq '.commands | keys' .claude-plugin/plugin.json` lists connect, status, diagnose, audit
5. Cross-reference: CONN-04 (list) and CONN-05 (remove) are covered by /status subcommands
6. Default site management and rename are covered per user decisions
</verification>

<success_criteria>
- commands/status/COMMAND.md provides complete site listing and profile management
- plugin.json accurately reflects all commands and their implementation status
- All remaining CONN requirements (CONN-04, CONN-05) are addressed
- Profile management operations use atomic jq updates consistent with /connect
</success_criteria>

<output>
After completion, create `.planning/phases/02-connection-file-sync/02-02-SUMMARY.md`
</output>
