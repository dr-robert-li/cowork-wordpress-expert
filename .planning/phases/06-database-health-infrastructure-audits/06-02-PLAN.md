---
phase: 06-database-health-infrastructure-audits
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - skills/diagnostic-https-audit/SKILL.md
  - skills/diagnostic-file-permissions/SKILL.md
autonomous: true
requirements:
  - INFR-01
  - INFR-02

must_haves:
  truths:
    - "HTTPS skill has two independently-gated sub-checks: Part A (WP-CLI config) runs only when WP_CLI_AVAILABLE=true, Part B (code grep) runs for any source type with LOCAL_PATH"
    - "HTTPS skill checks siteurl scheme, home URL scheme, and FORCE_SSL_ADMIN constant via WP-CLI"
    - "HTTPS skill greps all synced PHP/JS files for hardcoded http:// URLs with false-positive filtering"
    - "File permissions skill runs only for SSH source type and skips with explanatory Info finding for non-SSH"
    - "File permissions skill checks wp-config.php, .htaccess, wp-content/uploads/, wp-content/debug.log"
    - "debug.log is only flagged if WP_DEBUG is enabled"
    - "wp-config.php world-readable (644+) is Critical severity"
  artifacts:
    - path: "skills/diagnostic-https-audit/SKILL.md"
      provides: "HTTPS/SSL configuration audit with dual gating"
      contains: "FORCE_SSL_ADMIN"
    - path: "skills/diagnostic-file-permissions/SKILL.md"
      provides: "File permission checks (SSH-only)"
      contains: "stat -c %a"
  key_links:
    - from: "skills/diagnostic-https-audit/SKILL.md"
      to: "LOCAL_PATH"
      via: "grep on synced PHP/JS files for mixed content"
      pattern: "grep.*http://.*LOCAL_PATH"
    - from: "skills/diagnostic-file-permissions/SKILL.md"
      to: "SSH connection"
      via: "ssh stat commands on remote files"
      pattern: "ssh.*stat.*wp-config"
---

<objective>
Create two infrastructure audit skills: HTTPS/SSL configuration audit (dual-gated: WP-CLI part + code grep part) and file permission checks (SSH-only).

Purpose: Enable users to detect HTTPS misconfigurations and insecure file permissions that expose WordPress sites to security risks.

Output: Two new SKILL.md files in skills/diagnostic-https-audit/ and skills/diagnostic-file-permissions/
</objective>

<execution_context>
@/Users/robertli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robertli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-database-health-infrastructure-audits/06-RESEARCH.md
@skills/diagnostic-config-security/SKILL.md
@commands/diagnose/COMMAND.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create HTTPS/SSL configuration audit skill</name>
  <files>skills/diagnostic-https-audit/SKILL.md</files>
  <action>
Create `skills/diagnostic-https-audit/SKILL.md` — the first skill with dual-gating behavior.

**This skill is NOT in the WP_CLI_SKILLS array** — it handles its own gating internally because Part B runs without WP-CLI.

**Skill content must include:**

1. **Frontmatter:** name: diagnostic-https-audit, description of HTTPS/SSL config audit.

2. **Overview:** Explains what HTTPS misconfigurations mean for WordPress security (mixed content, admin not forced to SSL, non-HTTPS URLs).

3. **Part A: WP-CLI Config Checks (gated on WP_CLI_AVAILABLE=true)**

   Gate: `if [ "$WP_CLI_AVAILABLE" == "true" ]; then`

   Check 1 — siteurl scheme:
   ```bash
   SITEURL=$($WP_CLI_PREFIX option get siteurl 2>/dev/null | tr -d '[:space:]')
   ```
   If starts with `http://` → Warning finding (INFR-HTTPS-URL).

   Check 2 — home URL scheme:
   ```bash
   HOME_URL=$($WP_CLI_PREFIX option get home 2>/dev/null | tr -d '[:space:]')
   ```
   If starts with `http://` → Warning finding (INFR-HTTPS-URL, combined with siteurl).

   Check 3 — FORCE_SSL_ADMIN:
   ```bash
   FORCE_SSL_ADMIN=$($WP_CLI_PREFIX config get FORCE_SSL_ADMIN 2>/dev/null | tr -d '[:space:]')
   ```
   Not set, empty, "false", or "0" → Info finding (INFR-HTTPS-SSL): admin not forced to HTTPS.

   If WP_CLI_AVAILABLE=false, emit a note: "WP-CLI config checks skipped — source type does not support WP-CLI. Mixed content code scan ran on local files."

4. **Part B: Mixed Content Code Grep (always runs when LOCAL_PATH is set)**

   Grep all PHP and JS files in LOCAL_PATH for hardcoded http:// URLs:
   ```bash
   grep -rn \
     --include="*.php" --include="*.js" \
     --exclude-dir=".git" --exclude-dir="node_modules" --exclude-dir="vendor" \
     "http://[a-zA-Z0-9][a-zA-Z0-9.-]*\." \
     "$LOCAL_PATH/" 2>/dev/null | \
     grep -v "^\s*[*/#]" | \
     grep -v "localhost\|127\.0\.0\." | \
     grep -v "example\.com\|example\.org\|example\.net" | \
     grep -v "php\.net\|wordpress\.org\|w3\.org\|ietf\.org" | \
     grep -v "http://schemas\.\|http://www\.w3\." | \
     head -50
   ```

   Count matches. If > 0 → Warning finding (INFR-HTTPS-MXD) with count and first 5 file:line examples in detail.

   If no matches in Part B and all Part A checks pass → Info finding (INFR-HTTPS-OK): HTTPS configuration healthy.

5. **Finding IDs:** INFR-HTTPS-URL, INFR-HTTPS-SSL, INFR-HTTPS-MXD, INFR-HTTPS-OK.

6. **Finding JSON format** matching existing skills.

7. **Fix guidance:** For http:// URLs → update to https:// or use protocol-relative. For FORCE_SSL_ADMIN → `define('FORCE_SSL_ADMIN', true);` in wp-config.php.
  </action>
  <verify>File exists at skills/diagnostic-https-audit/SKILL.md. Contains: WP_CLI_AVAILABLE gating check, FORCE_SSL_ADMIN, grep with false-positive exclusions (php.net, wordpress.org, schemas, w3.org, example.com, localhost), INFR-HTTPS-URL, INFR-HTTPS-MXD, INFR-HTTPS-SSL, INFR-HTTPS-OK, LOCAL_PATH. Has both Part A (WP-CLI) and Part B (grep) clearly separated with independent gating.</verify>
  <done>HTTPS audit SKILL.md exists with dual-gated structure: Part A (WP-CLI config checks) runs only when WP-CLI available, Part B (code grep for http://) runs for any source type. False-positive filtering excludes doc URLs, XML namespaces, and example domains.</done>
</task>

<task type="auto">
  <name>Task 2: Create file permission check skill</name>
  <files>skills/diagnostic-file-permissions/SKILL.md</files>
  <action>
Create `skills/diagnostic-file-permissions/SKILL.md` — SSH-only skill.

**This skill is NOT in the WP_CLI_SKILLS array** — it handles its own SSH-only gating internally.

**Skill content must include:**

1. **Frontmatter:** name: diagnostic-file-permissions, description of file permission security checks.

2. **Overview:** Explains why file permissions matter for WordPress security (DB credentials in wp-config.php, server config in .htaccess, uploaded code in uploads/).

3. **Source type gate (SSH-only):**
   ```bash
   SOURCE_TYPE=$(jq -r ".sites[\"$SITE_NAME\"].source_type // \"ssh\"" sites.json)
   if [ "$SOURCE_TYPE" != "ssh" ]; then
     # Return Info finding INFR-PERM-SKP explaining skip
     # Reason: rsync normalizes permissions during sync; local copies don't reflect server permissions
     exit 0
   fi
   ```

4. **Permission checks via SSH `stat`** — For each file, use Linux stat syntax (SSH targets are Linux):
   ```bash
   PERMS=$(ssh $SSH_OPTS "${USER}@${HOST}" "stat -c %a '${FILE}' 2>/dev/null || echo 'NOT_FOUND'")
   ```

5. **Files to check and thresholds (per user decision):**

   **wp-config.php:**
   - 600, 640 = OK (Info)
   - 644 or looser (world-readable: check `$((8#$PERMS & 4))` for world read bit) = Critical (INFR-PERM-CFG)
   - Fix: `chmod 640 wp-config.php`

   **.htaccess:**
   - 644 = OK
   - 666 or 777 = Warning (INFR-PERM-HTA)
   - Fix: `chmod 644 .htaccess`

   **wp-content/uploads/:**
   - 755 = OK
   - 777 (world-writable) = Warning (INFR-PERM-UPL)
   - Fix: `chmod 755 wp-content/uploads`

   **wp-content/debug.log (conditional):**
   - First check WP_DEBUG: `$WP_CLI_PREFIX config get WP_DEBUG 2>/dev/null` (if WP-CLI available) or note that WP_DEBUG status unknown
   - Only flag if WP_DEBUG is enabled AND debug.log exists AND is world-readable
   - WP_DEBUG enabled + debug.log 644 = Warning (INFR-PERM-DBG): error traces exposed
   - Fix: `chmod 640 wp-content/debug.log` or disable WP_DEBUG in production

6. **NOT_FOUND handling:** If a file doesn't exist, skip it silently (no finding). debug.log not existing is normal.

7. **Finding IDs:** INFR-PERM-CFG, INFR-PERM-HTA, INFR-PERM-UPL, INFR-PERM-DBG, INFR-PERM-SKP.

8. **Finding JSON format** matching existing skills. Category: "Infrastructure".

9. If all permissions are OK, emit a single Info finding: "File permissions within recommended ranges."
  </action>
  <verify>File exists at skills/diagnostic-file-permissions/SKILL.md. Contains: source_type gate checking for "ssh", INFR-PERM-SKP finding for non-SSH, stat -c %a (Linux syntax), wp-config.php/htaccess/uploads/debug.log checks, WP_DEBUG conditional for debug.log, world-readable bit check, INFR-PERM-CFG, INFR-PERM-HTA, INFR-PERM-UPL, INFR-PERM-DBG, chmod recommendations in fix text.</verify>
  <done>File permissions SKILL.md exists with SSH-only gating, four file checks with per-file severity thresholds, conditional debug.log check tied to WP_DEBUG status, and explanatory skip finding for non-SSH sources.</done>
</task>

</tasks>

<verification>
1. HTTPS skill has clearly separated Part A (WP-CLI gated) and Part B (always runs) sections
2. HTTPS skill is NOT designed to be in WP_CLI_SKILLS array — it self-gates
3. File permissions skill checks source_type at the top and exits early for non-SSH
4. File permissions skill uses Linux stat syntax (`stat -c %a`) for SSH targets
5. debug.log is only flagged when WP_DEBUG is enabled
6. wp-config.php 644 or looser = Critical (world-readable DB credentials)
7. Severity levels are only Critical, Warning, Info (3-level system)
8. Both skills produce JSON findings matching existing skill format
</verification>

<success_criteria>
Two SKILL.md files exist: HTTPS audit with dual-gated structure (WP-CLI + code grep independently), and file permissions with SSH-only gating and conditional debug.log logic. Both produce structured JSON findings.
</success_criteria>

<output>
After completion, create `.planning/phases/06-database-health-infrastructure-audits/06-02-SUMMARY.md`
</output>
