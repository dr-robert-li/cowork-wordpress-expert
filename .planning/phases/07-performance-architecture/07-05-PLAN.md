---
phase: 07-performance-architecture
plan: 05
type: execute
wave: 2
depends_on:
  - 07-01
  - 07-02
  - 07-03
  - 07-04
files_modified:
  - commands/diagnose/COMMAND.md
autonomous: true
requirements:
  - PERF-01
  - PERF-02
  - PERF-03
  - ARCH-01
  - ARCH-02
  - ARCH-03

must_haves:
  truths:
    - "All 5 new Phase 7 skills appear in the full mode SKILLS array in /diagnose"
    - "diagnostic-arch-narrative is the LAST entry in the full mode SKILLS array"
    - "diagnostic-cron-analysis and diagnostic-wpcli-profile are added to WP_CLI_SKILLS array"
    - "diagnostic-performance-n1, diagnostic-architecture, and diagnostic-arch-narrative are NOT in WP_CLI_SKILLS"
    - "A new 'performance' mode exists with 3 skills: n1, cron-analysis, wpcli-profile"
    - "Mode description text updated to reflect 16 total skills in full mode"
    - "WP-CLI skip messages updated to include cron-analysis and wpcli-profile"
  artifacts:
    - path: "commands/diagnose/COMMAND.md"
      provides: "Updated diagnose command with all Phase 7 skills registered"
      contains: "diagnostic-performance-n1"
  key_links:
    - from: "commands/diagnose/COMMAND.md"
      to: "skills/diagnostic-performance-n1/SKILL.md"
      via: "SKILLS array entry in full mode"
      pattern: "diagnostic-performance-n1:N+1 Query"
    - from: "commands/diagnose/COMMAND.md"
      to: "skills/diagnostic-arch-narrative/SKILL.md"
      via: "SKILLS array entry — last position"
      pattern: "diagnostic-arch-narrative:Synthesized Narrative"
---

<objective>
Register all five new Phase 7 diagnostic skills in the /diagnose command. Add a new 'performance' mode. Update WP_CLI_SKILLS, mode descriptions, and skip messages.

Purpose: Skills only execute when registered in /diagnose. This plan wires all Phase 7 skills into the diagnostic workflow, ensuring narrative synthesis runs last and performance mode gives users a focused scan.

Output: Updated commands/diagnose/COMMAND.md
</objective>

<execution_context>
@/Users/robertli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robertli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-performance-architecture/07-01-SUMMARY.md
@.planning/phases/07-performance-architecture/07-02-SUMMARY.md
@.planning/phases/07-performance-architecture/07-03-SUMMARY.md
@.planning/phases/07-performance-architecture/07-04-SUMMARY.md
@commands/diagnose/COMMAND.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Register Phase 7 skills in /diagnose command</name>
  <files>commands/diagnose/COMMAND.md</files>
  <action>
Update `commands/diagnose/COMMAND.md` with all Phase 7 skill registrations. Read the current file first to understand the exact structure before making changes.

**1. Update frontmatter description:**
Change the modes description to include the new `performance` mode and update skill counts:
```yaml
modes:
  - full (default): All 16 diagnostic skills
  - security-only: core-integrity, config-security, user-audit
  - code-only: code-quality, malware-scan
  - performance: performance-n1, cron-analysis, wpcli-profile
```

**2. Update Section 1 Mode Detection** — add `performance` pattern detection:
```bash
# Add to mode detection patterns (before the else/full fallback)
elif echo "$USER_INPUT" | grep -qE "(performance|perf|n\+1|n1|cron|profile)"; then
  MODE="performance"
```

Update the Mode mappings comment to include:
```
- **performance:** Runs performance-focused skills (performance-n1, cron-analysis, wpcli-profile)
```

**3. Update Section 4 Determine Skills to Run** — add performance case and extend full mode:

```bash
case $MODE in
  "security-only")
    # ... unchanged ...
    ;;
  "code-only")
    # ... unchanged ...
    ;;
  "performance")
    SKILLS=(
      "diagnostic-performance-n1:N+1 Query Pattern Detection"
      "diagnostic-cron-analysis:Cron Event Analysis"
      "diagnostic-wpcli-profile:WP-CLI Profile Analysis"
    )
    ;;
  "full")
    SKILLS=(
      "diagnostic-core-integrity:Core Integrity Check"
      "diagnostic-config-security:Configuration Security"
      "diagnostic-user-audit:User Account Audit"
      "diagnostic-version-audit:Version Audit"
      "diagnostic-malware-scan:Malware Scan"
      "diagnostic-code-quality:Code Quality Analysis"
      "diagnostic-db-autoload:Autoload Bloat Analysis"
      "diagnostic-db-transients:Transient Buildup Check"
      "diagnostic-db-revisions:Post Revision Analysis"
      "diagnostic-https-audit:HTTPS Configuration Audit"
      "diagnostic-file-permissions:File Permission Check"
      "diagnostic-performance-n1:N+1 Query Pattern Detection"
      "diagnostic-cron-analysis:Cron Event Analysis"
      "diagnostic-wpcli-profile:WP-CLI Profile Analysis"
      "diagnostic-architecture:Architecture Review"
      "diagnostic-arch-narrative:Synthesized Narrative"
    )
    ;;
esac
```

CRITICAL ordering rules:
- `diagnostic-arch-narrative` MUST be the last entry in the full mode array
- `diagnostic-architecture` must appear before `diagnostic-arch-narrative`
- The existing 11 skills (Phase 1-6) must not be reordered

**4. Update WP_CLI_SKILLS array:**

Add ONLY the two new WP-CLI-dependent skills. Do NOT add diagnostic-performance-n1, diagnostic-architecture, or diagnostic-arch-narrative:

```bash
WP_CLI_SKILLS=(
  "diagnostic-core-integrity"
  "diagnostic-user-audit"
  "diagnostic-version-audit"
  "diagnostic-db-autoload"
  "diagnostic-db-transients"
  "diagnostic-db-revisions"
  "diagnostic-cron-analysis"
  "diagnostic-wpcli-profile"
)
```

Why NOT in WP_CLI_SKILLS:
- `diagnostic-performance-n1` — pure grep on synced files, no WP-CLI
- `diagnostic-architecture` — self-gates its own WP-CLI sections internally
- `diagnostic-arch-narrative` — AI synthesis, no WP-CLI or grep

**5. Update WP-CLI skip messages** — Where the command explains which skills will be skipped when WP-CLI is unavailable (the messages in the WP-CLI availability check section, around the "Note: WP-CLI not available" messages). Update the parenthetical skill list to include cron-analysis and wpcli-profile:

```bash
echo "WP-CLI-dependent skills (core-integrity, user-audit, version-audit, db-autoload, db-transients, db-revisions, cron-analysis, wpcli-profile) will be skipped."
```

Update this message in ALL locations where it appears (there are multiple — in the WP_CLI_AVAILABLE=false section and in each source-type case). Ensure consistent messaging across all variants.

**6. Update full mode description text** — Where the command describes "Runs all 11 diagnostic skills" (in Section 1 Mode Detection comment and anywhere else the count appears), update to 16. Update the full skill list in the description to include the 5 new skills.

Do NOT change:
- security-only mode array
- code-only mode array
- Any Section 1-3 logic
- Any Section 5-8 logic
- Report generation, health grade calculation, or completion summary sections
  </action>
  <verify>Read commands/diagnose/COMMAND.md and verify: (1) full mode SKILLS array has 16 entries with diagnostic-arch-narrative as the LAST entry, (2) performance mode exists with exactly 3 skills (n1, cron-analysis, wpcli-profile), (3) WP_CLI_SKILLS has 8 entries (6 existing + cron-analysis + wpcli-profile), (4) diagnostic-performance-n1 is NOT in WP_CLI_SKILLS, (5) diagnostic-architecture is NOT in WP_CLI_SKILLS, (6) diagnostic-arch-narrative is NOT in WP_CLI_SKILLS, (7) performance mode detection pattern present in mode detection section, (8) skip messages include cron-analysis and wpcli-profile.</verify>
  <done>commands/diagnose/COMMAND.md registers all 5 Phase 7 skills in full mode (narrative last), adds performance mode with 3 skills, extends WP_CLI_SKILLS to 8 entries, and updates all descriptive text and skip messages to reflect the new skill set.</done>
</task>

</tasks>

<verification>
1. Full mode SKILLS array: 16 entries total (11 existing + 5 new)
2. diagnostic-arch-narrative is entry [15] (last position, 0-indexed)
3. Performance mode: exactly 3 skills (performance-n1, cron-analysis, wpcli-profile)
4. WP_CLI_SKILLS: exactly 8 entries (6 existing + cron-analysis + wpcli-profile)
5. Excluded from WP_CLI_SKILLS: diagnostic-performance-n1, diagnostic-architecture, diagnostic-arch-narrative
6. Mode detection: "performance" pattern triggers new mode
7. security-only array: unchanged (3 skills)
8. code-only array: unchanged (2 skills)
9. WP-CLI skip messages: include cron-analysis and wpcli-profile in the parenthetical skill list
10. Full mode description updated from 11 to 16 skills
</verification>

<success_criteria>
The /diagnose command registers all 16 skills for full mode (with narrative last), adds a focused performance mode, and properly gates only the 2 WP-CLI-dependent Phase 7 skills via WP_CLI_SKILLS. All Phase 7 requirements (PERF-01, PERF-02, PERF-03, ARCH-01, ARCH-02, ARCH-03) are now accessible via /diagnose.
</success_criteria>

<output>
After completion, create `.planning/phases/07-performance-architecture/07-05-SUMMARY.md`
</output>
