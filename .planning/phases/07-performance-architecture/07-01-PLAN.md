---
phase: 07-performance-architecture
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - skills/diagnostic-performance-n1/SKILL.md
autonomous: true
requirements:
  - PERF-01

must_haves:
  truths:
    - "User can detect N+1 query patterns in custom theme and plugin PHP files"
    - "Each finding has a confidence tier: High, Medium, or Low"
    - "High confidence = query function (wpdb->get_results, WP_Query, get_posts) inside a foreach/while loop body"
    - "Medium confidence = get_post/get_post_meta inside a loop confirmed by AI reading surrounding context"
    - "Low confidence = multiple sequential wpdb->get_results calls on the same table in close proximity"
    - "Well-known third-party plugins (WooCommerce, Yoast, Elementor, etc.) are skipped — custom code only"
    - "Each finding includes a rewrite suggestion using actual variable names extracted from the file"
    - "Skill returns JSON array with finding IDs in PERF-N1-{hash} format"
  artifacts:
    - path: "skills/diagnostic-performance-n1/SKILL.md"
      provides: "N+1 query pattern detection with three-tier confidence"
      contains: "PERF-N1"
  key_links:
    - from: "skills/diagnostic-performance-n1/SKILL.md"
      to: ".sites/{site}/wp-content/themes/"
      via: "grep on synced PHP files"
      pattern: "foreach|while"
    - from: "skills/diagnostic-performance-n1/SKILL.md"
      to: ".sites/{site}/wp-content/plugins/"
      via: "grep on synced PHP files"
      pattern: "wpdb->|WP_Query|get_post"
---

<objective>
Create the diagnostic-performance-n1 skill that detects potential N+1 query patterns in custom WordPress theme and plugin code using a three-tier confidence system.

Purpose: N+1 queries are a leading cause of WordPress performance degradation — each iteration of a loop fires an additional database query, causing what should be a single query to scale linearly with content volume. Finding these patterns in custom code enables developers to batch-load data before the loop.

Output: skills/diagnostic-performance-n1/SKILL.md — a complete, executable skill specification
</objective>

<execution_context>
@/Users/robertli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robertli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-performance-architecture/07-RESEARCH.md
@skills/diagnostic-code-quality/SKILL.md
@skills/diagnostic-db-autoload/SKILL.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create diagnostic-performance-n1 SKILL.md</name>
  <files>skills/diagnostic-performance-n1/SKILL.md</files>
  <action>
Create `skills/diagnostic-performance-n1/SKILL.md` — a full skill specification for N+1 query pattern detection. Model structure on `skills/diagnostic-code-quality/SKILL.md` (two-pass analysis, WP.org plugin skip logic, finding ID format) and `skills/diagnostic-db-autoload/SKILL.md` (self-gating, output format).

**Skill Identity (frontmatter):**
```yaml
---
name: diagnostic-performance-n1
description: Detects potential N+1 query patterns in custom WordPress theme and plugin PHP code using three confidence tiers (High/Medium/Low). Skips well-known third-party plugins. Provides rewrite suggestions using actual variable names from the code.
---
```

**Overview section:** Explain N+1 anti-pattern — queries inside loops that multiply DB calls linearly with content. Explain why it matters (10 posts = 10 queries instead of 1, 100 posts = 100 queries). Explain custom-code-only scope: users cannot fix WooCommerce or Yoast internals, so flagging them wastes time.

**Prerequisites section:**
- `LOCAL_PATH` from sites.json (path to synced files)
- No WP-CLI required — this is purely static analysis on synced PHP files
- If `LOCAL_PATH` doesn't exist or is empty, return a single Info finding and stop

**Target Directories:**
```bash
THEME_DIR="${LOCAL_PATH}/wp-content/themes"
PLUGIN_DIR="${LOCAL_PATH}/wp-content/plugins"
```

**WP.org Plugin Skip List (same logic as diagnostic-code-quality):**
Skip these well-known plugin directories when scanning plugins/:
`woocommerce`, `woocommerce-*`, `wordpress-seo`, `yoast-*`, `elementor`, `elementor-*`, `contact-form-7`, `jetpack`, `akismet`, `classic-editor`, `wp-super-cache`, `wordfence`, `gravityforms`, `gravity-forms-*`, `ninja-forms`, `wpforms-*`, `the-events-calendar`, `tribe-*`, `wp-rocket`, `rankmath`, `seo-by-rank-math`, `advanced-custom-fields`, `acf-*`

Skip logic: for each plugin directory in plugins/, check if its name matches any entry in the skip list. If match, skip the entire directory. Log skipped plugin count in the finding detail.

**Pass 1 — Grep for Pattern Candidates:**

Collect candidate file:line references across three confidence tiers using grep on the target directories (skipping the well-known plugin list):

High confidence candidates (query function inside loop body — within 5 lines of a foreach/while):
```bash
# Find foreach/while lines, then check 5 lines after for query calls
grep -rn -E "(foreach|while)\s*\(.+\)" "$THEME_DIR" "$PLUGIN_DIR" \
  --include="*.php" -A 5 2>/dev/null | \
  grep -E "(\\\$wpdb->get_results|\\\$wpdb->get_row|\\\$wpdb->query|new WP_Query|get_posts\s*\(|get_post_meta\s*\(|get_term_meta\s*\()"
```

Medium confidence candidates (get_post/get_post_meta present — AI will check loop context):
```bash
grep -rn -E "(get_post|get_post_meta|get_term_meta|get_field|get_sub_field)\s*\(\s*\\\$" \
  "$THEME_DIR" "$PLUGIN_DIR" \
  --include="*.php" -B 10 -A 2 2>/dev/null
```

Low confidence candidates (multiple sequential wpdb->get_results in the same file within 10 lines):
```bash
grep -rn "\\\$wpdb->get_results\|\\\$wpdb->get_row" \
  "$THEME_DIR" "$PLUGIN_DIR" \
  --include="*.php" -n 2>/dev/null | \
  awk -F: 'prev_file==$1 && ($2+0)-(prev_line+0)<10 {print prev_entry"\n"$0} {prev_file=$1; prev_line=$2+0; prev_entry=$0}'
```

**Pass 2 — AI Contextual Analysis:**

For each candidate file flagged in Pass 1: read the relevant portion of the file (±20 lines around the match) and apply AI judgment to:

1. Confirm whether the query function is actually inside a loop body (not just near one)
2. Extract the actual variable names used (e.g., `$event_ids`, `$events`, not generic `$posts`)
3. Determine final confidence tier
4. Generate the rewrite suggestion

**Confidence Tier Rules (LOCKED — from user decisions):**
- **High:** Query function (`$wpdb->get_results`, `new WP_Query`, `get_posts()`, `get_post_meta()`) appears directly inside a `foreach` or `while` loop body
- **Medium:** `get_post()`, `get_post_meta()`, `get_term_meta()`, or `get_field()` called with a variable argument, and loop context confirmed within 10 lines before the call
- **Low:** Multiple sequential `$wpdb->get_results` or `$wpdb->get_row` calls on the same table within 10 lines in the same function, no loop present

**Finding Structure:**

Each N+1 pattern produces one finding:
```json
{
  "id": "PERF-N1-{hash}",
  "severity": "Warning",
  "category": "Performance",
  "title": "Potential N+1 query pattern [{confidence} confidence]",
  "summary": "A database query inside a loop may cause one query per iteration instead of loading all data in a single batch.",
  "detail": "File: {file}:{line}\nConfidence: {High|Medium|Low}\nPattern: {description of what was found}\nCode:\n{relevant code snippet}",
  "location": "{file}:{line}",
  "fix": "Before: {actual code from file with real variable names}\n\nAfter: {rewrite suggestion using the same variable names}\n\nPattern: Use get_posts() with post__in, get_terms() with include, or a single $wpdb->get_results() with WHERE IN (...) to batch-load all required data before the loop."
}
```

Finding ID hash: MD5 of `{file_path}:{line_number}:{pattern_type}`, truncated to 6 characters.

**Severity:** Always `Warning` for High and Medium confidence. `Info` for Low confidence (speculative — user may need to investigate).

**Rewrite suggestion examples (using actual variable names — NOT generic):**

If the code is:
```php
foreach ($event_ids as $event_id) {
    $event = get_post($event_id);
    $venue = get_post_meta($event_id, '_venue', true);
}
```

The fix field should say:
```
Before:
foreach ($event_ids as $event_id) {
    $event = get_post($event_id);
    $venue = get_post_meta($event_id, '_venue', true);
}

After:
$events = get_posts(['post__in' => $event_ids, 'posts_per_page' => -1]);
$venues = array_column(
    array_map(fn($id) => ['id' => $id, 'venue' => get_post_meta($id, '_venue', true)], $event_ids),
    'venue', 'id'
);
foreach ($events as $event) {
    $venue = $venues[$event->ID] ?? '';
}
```

**Output when no patterns found:**
```json
[{
  "id": "PERF-N1-CLEAN",
  "severity": "Info",
  "category": "Performance",
  "title": "No N+1 query patterns detected",
  "summary": "No potential N+1 query patterns were found in custom theme and plugin code.",
  "detail": "Scanned {FILE_COUNT} PHP files in {THEME_DIR} and {PLUGIN_DIR}. Skipped {SKIP_COUNT} well-known third-party plugin directories. No query-inside-loop patterns detected at High or Medium confidence.",
  "location": "wp-content/themes/, wp-content/plugins/ (custom code only)",
  "fix": "No action required."
}]
```

**Output when LOCAL_PATH missing:**
```json
[{
  "id": "PERF-N1-SKIP",
  "severity": "Info",
  "category": "Performance",
  "title": "N+1 analysis skipped — no local files",
  "summary": "N+1 detection requires locally synced PHP files to analyze.",
  "detail": "LOCAL_PATH does not exist or is empty. Run /connect or /diagnose which will sync files first.",
  "location": "LOCAL_PATH",
  "fix": "Run /diagnose which will sync files before running this analysis."
}]
```

**Implementation notes:**
- DO NOT grep inside node_modules/, vendor/, or .git/ directories — add --exclude-dir flags
- All grep commands use `2>/dev/null` to suppress permission errors
- File count for the "clean" finding: `find "$THEME_DIR" "$PLUGIN_DIR" -name "*.php" 2>/dev/null | wc -l`
- The well-known plugin skip list applies to `plugins/` subdirectory names only, not theme directories
  </action>
  <verify>Read skills/diagnostic-performance-n1/SKILL.md and verify: (1) frontmatter present with name and description, (2) three confidence tier definitions match LOCKED decisions (High=query-in-loop, Medium=get_post-in-loop, Low=sequential-queries), (3) well-known plugin skip list present, (4) finding ID format is PERF-N1-{hash}, (5) fix field uses actual variable names not generic examples, (6) output format matches JSON array with id/severity/category/title/summary/detail/location/fix fields, (7) PERF-N1-CLEAN finding exists for no-pattern case.</verify>
  <done>skills/diagnostic-performance-n1/SKILL.md exists with a complete skill specification covering all three confidence tiers, WP.org plugin skip logic, two-pass grep+AI analysis, rewrite suggestions with actual variable names, and all required output formats including the clean-scan and skip cases.</done>
</task>

</tasks>

<verification>
1. skills/diagnostic-performance-n1/ directory exists with SKILL.md
2. Skill covers High, Medium, Low confidence tiers with the LOCKED definitions
3. WP.org plugin skip list includes: woocommerce, wordpress-seo, elementor, jetpack, akismet, wordfence, gravityforms, advanced-custom-fields
4. Finding IDs follow PERF-N1-{hash} format
5. Fix field extracts actual variable names from file content (not generic $posts/$post_ids)
6. JSON output format has all 8 required fields: id, severity, category, title, summary, detail, location, fix
7. Clean-scan finding (PERF-N1-CLEAN) defined for when no patterns found
8. Skill does NOT require WP-CLI
</verification>

<success_criteria>
The N+1 detection skill exists and is complete enough that a Claude executor can follow it to scan WordPress custom code, identify query-in-loop patterns at three confidence levels, and produce actionable JSON findings with file:line references and concrete rewrite suggestions using actual variable names from the code.
</success_criteria>

<output>
After completion, create `.planning/phases/07-performance-architecture/07-01-SUMMARY.md`
</output>
