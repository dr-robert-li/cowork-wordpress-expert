---
phase: 07-performance-architecture
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - skills/diagnostic-arch-narrative/SKILL.md
autonomous: true
requirements:
  - ARCH-03

must_haves:
  truths:
    - "User receives a synthesized health narrative that pulls findings from ALL previous diagnostic runs (security, code quality, DB health, performance, architecture)"
    - "Narrative output is bullet-point grouped by domain, NOT prose paragraphs"
    - "Narrative includes overall A-F site health grade using the same grading matrix as existing reports"
    - "Narrative ends with 'Top 3 issues to fix first' ranked by impact"
    - "Skill reads from COMBINED_FINDINGS passed by /diagnose AND from memory/{site}/latest.md for cross-scan context"
    - "If memory/{site}/latest.md does not exist (first scan), skill synthesizes from current scan only and notes the absence"
    - "Skill produces exactly one finding: ARCH-NARR"
    - "Skill does NOT run any new checks — it only reads and synthesizes"
  artifacts:
    - path: "skills/diagnostic-arch-narrative/SKILL.md"
      provides: "AI-synthesized cross-domain architecture narrative"
      contains: "ARCH-NARR"
  key_links:
    - from: "skills/diagnostic-arch-narrative/SKILL.md"
      to: "COMBINED_FINDINGS (passed by /diagnose)"
      via: "reads all findings by severity and category prefix"
      pattern: "COMBINED_FINDINGS"
    - from: "skills/diagnostic-arch-narrative/SKILL.md"
      to: "memory/{site}/latest.md"
      via: "reads prior scan report for cross-session context"
      pattern: "latest.md"
---

<objective>
Create the diagnostic-arch-narrative skill — a unique aggregator/reader skill that synthesizes findings from the current diagnostic scan (and optionally prior scans) into a bullet-point health narrative with an overall A-F grade and "Top 3 issues to fix first" section.

Purpose: Individual skill findings are detailed and technical. Users need a single synthesized view across all domains (security, code, DB, performance, architecture) that tells them what matters most. This skill is the culminating output of a full diagnostic run.

Output: skills/diagnostic-arch-narrative/SKILL.md
</objective>

<execution_context>
@/Users/robertli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robertli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-performance-architecture/07-RESEARCH.md
@skills/report-generator/SKILL.md
@skills/diagnostic-db-autoload/SKILL.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create diagnostic-arch-narrative SKILL.md</name>
  <files>skills/diagnostic-arch-narrative/SKILL.md</files>
  <action>
Create `skills/diagnostic-arch-narrative/SKILL.md` — the synthesized narrative skill. This is unlike all other skills: it runs NO new checks. It reads `COMBINED_FINDINGS` (the full findings array assembled by /diagnose) and optionally the prior report at `memory/{site}/latest.md`, then produces a single structured narrative finding.

Read `skills/report-generator/SKILL.md` for the grading matrix (must use the same thresholds). The narrative's A-F grade must be identical to the grade report-generator would produce for the same findings.

**Skill Identity (frontmatter):**
```yaml
---
name: diagnostic-arch-narrative
description: Synthesizes findings from all diagnostic skills into a bullet-point health narrative grouped by domain (Security, Code Quality, Database Health, Performance, Architecture, Infrastructure). Applies the standard A-F grading matrix and produces a "Top 3 issues to fix first" ranked list. MUST run last in the skill sequence — it reads COMBINED_FINDINGS from all preceding skills.
---
```

**Overview section:** This skill is an aggregator, not a probe. It does not connect to WordPress, run grep, or execute WP-CLI commands. It reads the structured findings produced by all other skills in the current run, optionally enriches context from the prior report, and produces a single synthesized narrative that gives users a cross-domain view of their site's health.

**IMPORTANT:** This skill must be registered LAST in the /diagnose full-mode skill list. If it runs before other skills complete, COMBINED_FINDINGS will be incomplete and the narrative will be misleading.

**Input Sources:**

1. `COMBINED_FINDINGS` — JSON array of all findings from the current diagnostic run (passed by /diagnose at completion of all preceding skills)
2. `memory/{site}/latest.md` — Prior report file (optional — may not exist on first scan)

```bash
MEMORY_DIR="memory/${SITE_NAME}"
PRIOR_REPORT="${MEMORY_DIR}/latest.md"

# Check if prior report exists
PRIOR_SCAN_EXISTS=false
if [ -f "$PRIOR_REPORT" ]; then
  PRIOR_SCAN_EXISTS=true
fi
```

**Step 1 — Apply Grading Matrix (same as report-generator):**

Count findings by severity from COMBINED_FINDINGS:
```bash
CRITICAL_TOTAL=$(echo "$COMBINED_FINDINGS" | jq '[.[] | select(.severity == "Critical")] | length')
WARNING_TOTAL=$(echo "$COMBINED_FINDINGS" | jq '[.[] | select(.severity == "Warning")] | length')
INFO_TOTAL=$(echo "$COMBINED_FINDINGS" | jq '[.[] | select(.severity == "Info")] | length')
```

Apply grading matrix (first-match-wins — IDENTICAL to report-generator thresholds):
```bash
if [ "$CRITICAL_TOTAL" -ge 4 ]; then
  HEALTH_GRADE="F"
elif [ "$CRITICAL_TOTAL" -ge 2 ]; then
  HEALTH_GRADE="D"
elif [ "$CRITICAL_TOTAL" -eq 1 ]; then
  HEALTH_GRADE="C"
elif [ "$WARNING_TOTAL" -ge 5 ]; then
  HEALTH_GRADE="C"
elif [ "$WARNING_TOTAL" -ge 3 ]; then
  HEALTH_GRADE="B"
else
  HEALTH_GRADE="A"
fi
```

**Step 2 — Group Findings by Domain:**

Group findings by their category prefix. Use the `category` field from each finding:

| Domain | Category values |
|--------|----------------|
| Security | "Security" |
| Code Quality | "Code Quality" |
| Database Health | "Database Health" |
| Performance | "Performance" |
| Architecture | "Architecture" |
| Infrastructure | "Infrastructure" |

For each domain, collect counts and top-severity findings:
```bash
# Example for Security domain
SECURITY_FINDINGS=$(echo "$COMBINED_FINDINGS" | jq '[.[] | select(.category == "Security")]')
SECURITY_CRITICAL=$(echo "$SECURITY_FINDINGS" | jq '[.[] | select(.severity == "Critical")] | length')
SECURITY_WARNING=$(echo "$SECURITY_FINDINGS" | jq '[.[] | select(.severity == "Warning")] | length')
```

**Step 3 — Derive Top 3 Issues:**

Priority ordering for "Top 3 issues to fix first":
1. All Critical findings sorted by domain business impact: Security > Database Health > Performance > Code Quality > Architecture > Infrastructure
2. If fewer than 3 Critical findings, fill remaining slots with Warning findings (same domain priority order)
3. If fewer than 3 total Critical+Warning findings, fill with highest-impact Info findings

Extract top 3:
```bash
TOP_3=$(echo "$COMBINED_FINDINGS" | jq '
  [
    (.[] | select(.severity == "Critical")),
    (.[] | select(.severity == "Warning")),
    (.[] | select(.severity == "Info"))
  ] | .[0:3]
')
```

**Step 4 — Compose Narrative Finding:**

The narrative skill produces EXACTLY ONE finding:
```json
{
  "id": "ARCH-NARR",
  "severity": "{A/B = Info, C = Warning, D/F = Critical}",
  "category": "Architecture",
  "title": "Site Health Narrative — Grade {HEALTH_GRADE}",
  "summary": "Overall site health: {HEALTH_GRADE}. {CRITICAL_TOTAL} critical, {WARNING_TOTAL} warning, {INFO_TOTAL} informational findings across {DOMAIN_COUNT} domains.",
  "detail": "{NARRATIVE_BODY}",
  "location": "Cross-domain synthesis",
  "fix": "Top 3 issues to fix first:\n1. {issue_1_title} — {issue_1_fix_summary}\n2. {issue_2_title} — {issue_2_fix_summary}\n3. {issue_3_title} — {issue_3_fix_summary}"
}
```

Narrative severity: Info for grades A/B, Warning for grade C, Critical for grades D/F.

**NARRATIVE_BODY structure (LOCKED — bullet-point by domain, NOT prose):**

```
## Overall Health: Grade {A-F}

Scan covered {N} domains with {TOTAL} findings total.
{If PRIOR_SCAN_EXISTS: "Prior scan data included from memory/{site}/latest.md for context."}
{If NOT PRIOR_SCAN_EXISTS: "First scan — no prior data available for trend comparison."}

### Security
- {bullet point for each Critical/Warning finding in Security domain, or "No issues found" if clean}
- Total: {X critical, Y warning, Z info}

### Code Quality
- {bullet points}
- Total: {X critical, Y warning, Z info}

### Database Health
- {bullet points}
- Total: {X critical, Y warning, Z info}

### Performance
- {bullet points}
- Total: {X critical, Y warning, Z info}

### Architecture
- {bullet points}
- Total: {X critical, Y warning, Z info}

### Infrastructure
- {bullet points}
- Total: {X critical, Y warning, Z info}

{If any domain has no findings:}
Domains with no issues: {list them}
```

Each domain bullet point format: `- [{Severity}] {finding.title}: {one-sentence summary of fix}`

For domains with many findings (>5), summarize: "- 3 critical findings in Security: [list titles]" rather than one bullet per finding.

**Prior Scan Context (if memory/{site}/latest.md exists):**

Read the prior report to extract its health grade. Include in summary:
```
Prior scan grade: {prior_grade} → Current grade: {current_grade}
{If improved: "Health improved since last scan."}
{If degraded: "Health degraded since last scan — review new findings."}
{If same: "Health grade unchanged since last scan."}
```

The prior report reading is supplementary context only — the narrative grade is always computed fresh from COMBINED_FINDINGS.

**When COMBINED_FINDINGS is empty or missing:**
```json
{
  "id": "ARCH-NARR",
  "severity": "Warning",
  "category": "Architecture",
  "title": "Narrative synthesis skipped — no findings data",
  "summary": "No findings were available to synthesize. This skill must run after all other skills complete.",
  "detail": "COMBINED_FINDINGS is empty or was not passed correctly. Ensure diagnostic-arch-narrative runs last in the skill list and that at least one other skill completed successfully.",
  "location": "Cross-domain synthesis",
  "fix": "Re-run /diagnose full mode to generate a complete findings set."
}
```

**Implementation note — This skill executes differently from other skills:**
Unlike probe skills that run bash commands, this skill is entirely AI-driven synthesis. Claude reads COMBINED_FINDINGS (JSON), groups by category, counts by severity, applies the grading matrix, and writes the narrative directly. No bash commands needed for the synthesis itself — only for reading the prior report file.
  </action>
  <verify>Read skills/diagnostic-arch-narrative/SKILL.md and verify: (1) skill produces exactly ONE finding with ID ARCH-NARR, (2) grading matrix thresholds match report-generator (4+ critical = F, 2-3 = D, 1 = C, 5+ warnings = C, 3-4 = B, else = A), (3) output format is bullet-point grouped by domain NOT prose paragraphs, (4) "Top 3 issues" in the fix field ranked by severity then domain impact, (5) prior scan check via memory/{site}/latest.md existence, (6) empty COMBINED_FINDINGS handled gracefully, (7) warning in skill docs that this MUST run last.</verify>
  <done>skills/diagnostic-arch-narrative/SKILL.md exists as a complete specification for the aggregator skill producing a single ARCH-NARR finding with grade-consistent severity, domain-grouped bullet-point narrative, and "Top 3 issues to fix first" ranked list.</done>
</task>

</tasks>

<verification>
1. skills/diagnostic-arch-narrative/ directory exists with SKILL.md
2. Produces exactly ONE finding (ARCH-NARR) — no per-file hashes needed
3. Grading matrix is identical to report-generator thresholds
4. Narrative severity maps: A/B → Info, C → Warning, D/F → Critical
5. Output is bullet-point by domain, NOT prose paragraphs (LOCKED decision)
6. "Top 3 issues to fix first" in fix field, ranked Critical > Warning > Info, Security > DB > Performance priority
7. Prior scan context read from memory/{site}/latest.md with grade comparison
8. First-scan case handled (notes no prior data)
9. Empty COMBINED_FINDINGS case handled with Warning finding
10. Skill documentation states it MUST run last in skill sequence
</verification>

<success_criteria>
The arch-narrative skill exists as a complete specification for an AI synthesis skill (no new checks, reads findings). It produces one structured ARCH-NARR finding with a bullet-point cross-domain narrative, consistent A-F grade, and a top-3 actionable ranking. The spec is clear enough that a Claude executor following it will produce a narrative consistent with the site's actual findings.
</success_criteria>

<output>
After completion, create `.planning/phases/07-performance-architecture/07-04-SUMMARY.md`
</output>
