---
phase: 03-diagnostic-skills-reporting
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - skills/diagnostic-version-audit/SKILL.md
  - skills/diagnostic-malware-scan/SKILL.md
autonomous: true

must_haves:
  truths:
    - "Plugin checks PHP/WordPress/MySQL version compatibility and plugin/theme update status"
    - "Plugin checks installed plugins and themes against WordPress.org for available updates"
    - "Plugin scans synced files for suspicious code patterns as a separate finding category from core integrity"
  artifacts:
    - path: "skills/diagnostic-version-audit/SKILL.md"
      provides: "Version compatibility and update status checking via WP-CLI"
      min_lines: 100
    - path: "skills/diagnostic-malware-scan/SKILL.md"
      provides: "Pattern-based suspicious code detection on synced files"
      min_lines: 100
  key_links:
    - from: "skills/diagnostic-version-audit/SKILL.md"
      to: "WP-CLI plugin/theme list"
      via: "SSH command execution"
      pattern: "wp plugin list.*update=available"
    - from: "skills/diagnostic-version-audit/SKILL.md"
      to: "WordPress.org API"
      via: "curl to api.wordpress.org"
      pattern: "api.wordpress.org"
    - from: "skills/diagnostic-malware-scan/SKILL.md"
      to: "synced site files"
      via: "local grep on .sites/{site-name}/"
      pattern: "grep.*eval.*base64_decode"
---

<objective>
Create two diagnostic skill prompts: version/compatibility auditing and suspicious code (malware) scanning.

Purpose: Version audit detects outdated software that may have known vulnerabilities. Malware scan detects suspicious code patterns in synced files as a distinct category from core integrity checking.

Output: Two SKILL.md files, each a self-contained prompt for Claude to perform a specific diagnostic and return structured findings.
</objective>

<execution_context>
@/Users/robertli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robertli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-diagnostic-skills-reporting/03-CONTEXT.md
@.planning/phases/03-diagnostic-skills-reporting/03-RESEARCH.md
@commands/connect/COMMAND.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create version audit diagnostic skill</name>
  <files>skills/diagnostic-version-audit/SKILL.md</files>
  <action>
Create SKILL.md following CoWork skill format (YAML frontmatter with name + description, then markdown prompt body).

**skills/diagnostic-version-audit/SKILL.md** (SECR-02, DIAG-01, DIAG-02):
- YAML frontmatter: name "diagnostic-version-audit", description explaining it checks WordPress core, PHP, MySQL, plugin, and theme versions for compatibility and available updates
- Skill prompt instructs Claude to perform four version checks:

**Check 1: WordPress core version (DIAG-01)**
- Run `ssh {user}@{host} "cd {wp_path} && {wp_cli_path} core version"` to get current version
- Run `ssh {user}@{host} "cd {wp_path} && {wp_cli_path} core check-update --format=json"` to check for updates
- If update available: Warning finding (minor update) or Critical finding (major security update)
- Finding ID: DIAG-VERSION-{hash}

**Check 2: PHP version (DIAG-01)**
- Run `ssh {user}@{host} "php -v"` and parse version number
- Check against known support status: PHP < 8.0 = Critical (end of security support), PHP 8.0 = Warning (approaching EOL), PHP 8.1+ = Info (supported)
- Finding ID: DIAG-PHP-{hash}

**Check 3: MySQL/MariaDB version (DIAG-01)**
- Run `ssh {user}@{host} "cd {wp_path} && {wp_cli_path} db version"` to get database version
- MySQL < 8.0 or MariaDB < 10.5 = Warning
- Finding ID: DIAG-DB-{hash}

**Check 4: Plugin and theme updates (SECR-02, DIAG-02)**
- Run `ssh {user}@{host} "cd {wp_path} && {wp_cli_path} plugin list --format=json"` for full plugin inventory
- Run `ssh {user}@{host} "cd {wp_path} && {wp_cli_path} plugin list --update=available --format=json"` for outdated plugins
- Run same for themes: `wp theme list --format=json` and `wp theme list --update=available --format=json`
- For each outdated plugin/theme: Warning finding with current version, available version, and update instructions
- Per user decision: Use WP-CLI + WordPress.org data only, NO WPScan API
- For plugins with updates available, optionally check WordPress.org API (`https://api.wordpress.org/plugins/info/1.2/?action=plugin_information&request[slug]={slug}`) to get `tested` field -- if plugin not tested with current WP version, add compatibility note to finding
- Finding ID: DIAG-PLUGIN-{3-char-md5-of-plugin-slug} or DIAG-THEME-{hash}

Each finding includes: one-sentence non-technical summary, technical detail with version numbers, fix suggestion (e.g., "Run `wp plugin update {slug}` or update via WordPress admin dashboard").

Handle errors: WP-CLI not available = skip checks with Warning finding. SSH timeout = Warning with details. Parse errors on non-JSON output = graceful fallback.
  </action>
  <verify>
File exists with YAML frontmatter. Skill covers all 4 check types: WP core version, PHP version, MySQL/MariaDB version, plugin/theme updates. Uses WP-CLI --format=json. References WordPress.org API for compatibility info. Does NOT reference WPScan or any API requiring keys.
  </verify>
  <done>
skills/diagnostic-version-audit/SKILL.md exists with 100+ lines covering WordPress/PHP/MySQL version checks and plugin/theme update auditing via WP-CLI over SSH, with WordPress.org API for compatibility data, deterministic finding IDs, and no external API key dependencies.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create malware/suspicious code scan diagnostic skill</name>
  <files>skills/diagnostic-malware-scan/SKILL.md</files>
  <action>
Create SKILL.md following CoWork skill format.

**skills/diagnostic-malware-scan/SKILL.md** (maps to "Suspicious Code" category in reports):
- YAML frontmatter: name "diagnostic-malware-scan", description explaining it scans synced WordPress files for suspicious code patterns and potential malware
- Skill prompt instructs Claude to:

**Important distinction per user decision:** This is a SEPARATE category from core integrity (which uses WP-CLI verify-checksums). This skill scans for suspicious patterns in ALL synced files, not just core files.

**Scan location:** Local synced files at `.sites/{site-name}/` (NOT remote -- files already synced by /connect). This makes grep fast and avoids SSH overhead.

**Pattern categories to scan (using grep/egrep on local files):**

1. **Obfuscation chains** (Critical):
   - `eval\s*(\s*base64_decode` (eval of decoded content)
   - `base64_decode.*base64_decode` (double encoding)
   - `gzinflate.*base64_decode` or `gzuncompress.*base64_decode`
   - `str_rot13` combined with `eval` or `base64_decode`
   - NOTE: Do NOT flag standalone `base64_decode` (too many false positives per research). Only flag when combined with eval/exec/double-encoding.

2. **Known backdoor signatures** (Critical):
   - `FilesMan`, `WSO`, `c99shell`, `r57shell`, `b374k` (case-insensitive)
   - `shell_exec\s*(\s*\$_` or `system\s*(\s*\$_` or `passthru\s*(\s*\$_` (shell execution of user input)

3. **Suspicious file placements** (Warning):
   - PHP files in `wp-content/uploads/` directory: `find .sites/{site-name}/wp-content/uploads -name "*.php" -type f`
   - Unexpected files in `wp-includes/` that are not standard WordPress core files (check for .php files not in the standard WP-CLI checksums list)

4. **Dangerous function usage with user input** (Warning):
   - `eval\s*(\s*\$` (eval with variable -- not just eval with string literal)
   - `assert\s*(\s*\$` (assert with variable input)
   - `preg_replace.*\/e` (deprecated /e modifier)
   - `create_function` (deprecated, often used in exploits)

**For each pattern match, generate a finding with:**
- id: SUSP-{PATTERN_TYPE}-{3-char-md5-of-filepath:line}
- severity: Critical or Warning (as noted above)
- category: "Suspicious Code" (NOT "Security" -- per user decision, separate category)
- title: descriptive title of what was found
- summary: one non-technical sentence explaining the risk
- detail: the matched line content with surrounding context (2 lines before/after), file path, line number
- location: "{relative-file-path}:{line-number}"
- fix: specific recommendation (e.g., "Investigate this file -- if you did not add this code, it may be malware. Compare with the original plugin/theme source. If confirmed malicious, delete the file and check for other compromised files.")

**False positive reduction per research:**
- Skip files in `node_modules/` and `vendor/` directories
- Skip `.min.js` files (often contain legitimate base64 for data URIs)
- For base64_decode matches, only flag when combined with eval/exec patterns
- Note in findings when a match is in a known WP.org plugin directory (lower confidence)

Return findings as JSON array.
  </action>
  <verify>
File exists with YAML frontmatter. Category is "Suspicious Code" (not "Security"). Scans LOCAL synced files (not remote). Covers all 4 pattern categories: obfuscation chains, backdoor signatures, suspicious placements, dangerous functions. Has false positive reduction rules. Does NOT flag standalone base64_decode.
  </verify>
  <done>
skills/diagnostic-malware-scan/SKILL.md exists with 100+ lines covering pattern-based suspicious code scanning on locally synced files, using grep with specific malware signatures and obfuscation patterns, false positive reduction, separate "Suspicious Code" category, and deterministic finding IDs.
  </done>
</task>

</tasks>

<verification>
Phase-level checks for this plan:
1. Both SKILL.md files exist in their respective skills/ subdirectories
2. Each file has valid YAML frontmatter (name, description)
3. Version audit covers WordPress, PHP, MySQL/MariaDB, plugins, and themes
4. Malware scan uses "Suspicious Code" category (separate from "Security")
5. Malware scan operates on local synced files, not remote
6. Version audit uses only WP-CLI + WordPress.org API (no WPScan, no API keys)
7. Both skills return findings in standard format with deterministic IDs
8. Severity levels use exactly: Critical, Warning, Info
</verification>

<success_criteria>
Two diagnostic skills created as self-contained SKILL.md prompts. Version audit skill checks WordPress/PHP/MySQL versions and plugin/theme update status via WP-CLI over SSH with WordPress.org API for compatibility data. Malware scan skill checks locally synced files for obfuscation chains, backdoor signatures, suspicious placements, and dangerous function usage with false positive reduction.
</success_criteria>

<output>
After completion, create `.planning/phases/03-diagnostic-skills-reporting/03-02-SUMMARY.md`
</output>
