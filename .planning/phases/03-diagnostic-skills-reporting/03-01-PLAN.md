---
phase: 03-diagnostic-skills-reporting
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - skills/diagnostic-core-integrity/SKILL.md
  - skills/diagnostic-config-security/SKILL.md
  - skills/diagnostic-user-audit/SKILL.md
autonomous: true

must_haves:
  truths:
    - "Plugin verifies WordPress core file integrity against known-good checksums"
    - "Plugin audits user accounts for security issues (default admin username, excessive admins, inactive privileged users)"
    - "Plugin checks wp-config.php for critical security misconfigurations only"
  artifacts:
    - path: "skills/diagnostic-core-integrity/SKILL.md"
      provides: "Core file integrity checking via WP-CLI verify-checksums over SSH"
      min_lines: 80
    - path: "skills/diagnostic-config-security/SKILL.md"
      provides: "wp-config.php security analysis via SSH grep commands"
      min_lines: 80
    - path: "skills/diagnostic-user-audit/SKILL.md"
      provides: "User account security auditing via WP-CLI user commands over SSH"
      min_lines: 60
  key_links:
    - from: "skills/diagnostic-core-integrity/SKILL.md"
      to: "WP-CLI verify-checksums"
      via: "SSH command execution"
      pattern: "wp core verify-checksums"
    - from: "skills/diagnostic-config-security/SKILL.md"
      to: "wp-config.php"
      via: "SSH grep commands"
      pattern: "WP_DEBUG|DISALLOW_FILE_EDIT|salts"
    - from: "skills/diagnostic-user-audit/SKILL.md"
      to: "WP-CLI user list"
      via: "SSH command execution"
      pattern: "wp user list"
---

<objective>
Create three security-focused diagnostic skill prompts: core file integrity checking, wp-config.php security analysis, and user account auditing.

Purpose: These skills enable the plugin to detect the most common WordPress security issues -- modified core files, insecure configuration, and risky user account setups -- using WP-CLI and SSH commands with zero external dependencies.

Output: Three SKILL.md files in skills/ subdirectories, each a self-contained markdown prompt that Claude follows to perform a specific security diagnostic and return structured findings.
</objective>

<execution_context>
@/Users/robertli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robertli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-diagnostic-skills-reporting/03-CONTEXT.md
@.planning/phases/03-diagnostic-skills-reporting/03-RESEARCH.md
@commands/connect/COMMAND.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create core integrity and config security diagnostic skills</name>
  <files>skills/diagnostic-core-integrity/SKILL.md, skills/diagnostic-config-security/SKILL.md</files>
  <action>
Create two SKILL.md files following the CoWork plugin skill format (YAML frontmatter with name + description, then markdown prompt body).

**skills/diagnostic-core-integrity/SKILL.md** (SECR-01):
- YAML frontmatter: name "diagnostic-core-integrity", description explaining it checks WordPress core files against official checksums
- Skill prompt instructs Claude to:
  1. Load site connection details from sites.json (host, user, wp_path, wp_cli_path)
  2. Run `wp core verify-checksums --format=json` over SSH (with `cd {wp_path} &&` prefix, using full wp_cli_path)
  3. Handle three outcomes: (a) exit 0 with no output = all files verified, produce Info finding "Core files verified"; (b) exit non-zero with JSON array of modified files = produce Critical finding per modified file; (c) WP-CLI error/timeout = produce Warning finding with error details
  4. For each modified file, generate a finding object with: id (format SECR-CHECKSUMS-{3-char-md5-of-filepath}), severity "Critical", category "Security", title "Modified core file: {filename}", summary (one non-technical sentence), detail (technical: which file, what checksum says), location (file path), fix ("Run `wp core download --force --skip-content` to restore core files, or manually restore {filename} from WordPress.org")
  5. Include SSH error handling: check exit code, capture stderr, provide specific diagnosis for "command not found" (WP-CLI path issue) and "Connection refused" (SSH issue)
  6. Include note about using `--exclude=readme.html,license.txt` to skip files commonly modified by hosts
  7. Return findings as JSON array

**skills/diagnostic-config-security/SKILL.md** (SECR-04):
- YAML frontmatter: name "diagnostic-config-security", description explaining it checks wp-config.php for critical security issues
- Skill prompt instructs Claude to:
  1. Load site connection details from sites.json
  2. Run checks REMOTELY via SSH (do NOT rely on local synced copy -- wp-config.php may not be synced). Use `ssh {user}@{host} "grep ..." {wp_path}/wp-config.php` pattern
  3. Check these items per user decision (critical issues only):
     - WP_DEBUG set to true: `grep -E "define\s*\(\s*['\"]WP_DEBUG['\"].*true" {wp_path}/wp-config.php` -- if found, Critical finding
     - Default/empty salts: `grep "put your unique phrase here" {wp_path}/wp-config.php` -- if found, Critical finding
     - DISALLOW_FILE_EDIT absent or false: check for `define.*DISALLOW_FILE_EDIT.*true` -- if NOT found, Warning finding
     - Default table prefix: `grep '^\$table_prefix.*wp_' {wp_path}/wp-config.php` -- if found, Info finding (not Critical per user decision)
     - DB credentials in version control: check if `.git` directory exists alongside wp-config.php and if wp-config.php is tracked -- if yes, Warning finding
  4. Per user decision, explicitly SKIP: table prefix recommendations, memory limit values, obscure hardening settings
  5. Generate deterministic finding IDs: SECR-CONFIG-{3-char-md5-of-check-name}
  6. Each finding includes fix snippet (e.g., "Add `define('DISALLOW_FILE_EDIT', true);` to wp-config.php")
  7. Handle edge case: wp-config.php might be one directory above wp_path (WordPress supports this) -- check both locations
  8. Return findings as JSON array

Reference the SSH execution pattern from connect COMMAND.md: always use `ssh -o BatchMode=yes -o ConnectTimeout=10` and check exit codes. Reference the finding format from CONTEXT.md (id, severity, category, title, summary, detail, location, fix).
  </action>
  <verify>
Both files exist with YAML frontmatter. Core integrity skill references `wp core verify-checksums`. Config security skill references all 5 check items (WP_DEBUG, salts, DISALLOW_FILE_EDIT, table_prefix, git-tracked credentials). Neither skill references external APIs or tools beyond WP-CLI and SSH.
  </verify>
  <done>
skills/diagnostic-core-integrity/SKILL.md exists with 80+ lines covering WP-CLI verify-checksums over SSH, JSON output parsing, per-file findings with deterministic IDs, and SSH error handling. skills/diagnostic-config-security/SKILL.md exists with 80+ lines covering all 5 wp-config checks via remote SSH grep, with explicit skip list for debatable settings per user decision.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create user account audit diagnostic skill</name>
  <files>skills/diagnostic-user-audit/SKILL.md</files>
  <action>
Create SKILL.md following CoWork skill format.

**skills/diagnostic-user-audit/SKILL.md** (SECR-03):
- YAML frontmatter: name "diagnostic-user-audit", description explaining it audits WordPress user accounts for security issues
- Skill prompt instructs Claude to:
  1. Load site connection details from sites.json
  2. Run three checks via WP-CLI over SSH:
     a. **Default admin username**: `ssh {user}@{host} "cd {wp_path} && {wp_cli_path} user list --field=user_login --format=json"` then check if "admin" exists in the list. If found: Critical finding (SECR-USERS-{hash}), title "Default 'admin' username in use", fix "Create a new administrator account with a unique username, transfer content ownership, then delete the 'admin' account"
     b. **Excessive administrators**: `ssh {user}@{host} "cd {wp_path} && {wp_cli_path} user list --role=administrator --format=count"` -- if count > 3: Warning finding, title "Excessive administrator accounts ({count})", fix "Review administrator accounts and demote unnecessary users to Editor or lower roles"
     c. **Inactive privileged users** (best-effort): For each admin user, check `wp user meta get {user_id} last_login` -- if meta key exists and value is older than 90 days, Warning finding. If meta key doesn't exist (no login tracking plugin), skip gracefully and add Info finding: "Last login tracking not available -- consider installing a login audit plugin"
  3. Per user decision, explicitly do NOT check: email domain analysis, capability overrides, subscriber ratios
  4. Generate deterministic finding IDs: SECR-USERS-{3-char-md5-of-check+identifier}
  5. Each finding has one-sentence non-technical summary + technical detail + fix suggestion
  6. Return findings as JSON array

Use `--format=json` for all WP-CLI commands to get structured output. Handle WP-CLI errors gracefully (return Warning finding if command fails).
  </action>
  <verify>
File exists with YAML frontmatter. Skill references all 3 check types: default admin username, admin count > 3, inactive privileged users. Skill explicitly notes what is NOT checked per user decision. Skill uses `--format=json` for WP-CLI output.
  </verify>
  <done>
skills/diagnostic-user-audit/SKILL.md exists with 60+ lines covering three user account checks via WP-CLI over SSH, graceful degradation for missing last_login meta, explicit exclusion list per user decision, and deterministic finding IDs.
  </done>
</task>

</tasks>

<verification>
Phase-level checks for this plan:
1. All three SKILL.md files exist in their respective skills/ subdirectories
2. Each file has valid YAML frontmatter (name, description)
3. Each skill returns findings in the standard format: {id, severity, category, title, summary, detail, location, fix}
4. Finding IDs follow SECR-{CHECK}-{hash} format
5. Severity levels use exactly: Critical, Warning, Info (3-level per user decision)
6. No references to external APIs, WPScan, or tools requiring API keys
7. All remote operations use SSH, not local file access
</verification>

<success_criteria>
Three security diagnostic skills created as self-contained SKILL.md prompts. Each skill instructs Claude to connect via SSH, run specific WP-CLI/grep checks, and return structured findings with deterministic IDs, severity ratings, non-technical summaries, and fix snippets. Skills cover SECR-01 (core checksums), SECR-03 (user audit), and SECR-04 (wp-config security).
</success_criteria>

<output>
After completion, create `.planning/phases/03-diagnostic-skills-reporting/03-01-SUMMARY.md`
</output>
