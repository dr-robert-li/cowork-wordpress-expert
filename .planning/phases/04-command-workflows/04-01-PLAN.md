---
phase: 04-command-workflows
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [commands/diagnose/COMMAND.md]
autonomous: true

must_haves:
  truths:
    - "User can run /diagnose and get a full diagnostic report covering all 6 skills"
    - "User can run /diagnose with security-only or code-only mode to narrow scope"
    - "User sees inline progress as each skill runs with finding counts"
    - "Critical findings are shown immediately as discovered"
    - "If a skill fails, it is skipped and remaining skills continue"
    - "Report is saved to memory/{site}/latest.md with health grade"
    - "Suggested next actions appear after scan completion"
    - "/diagnose auto-connects if no synced files exist for the site"
  artifacts:
    - path: "commands/diagnose/COMMAND.md"
      provides: "Complete /diagnose command workflow"
      min_lines: 200
  key_links:
    - from: "commands/diagnose/COMMAND.md"
      to: "skills/diagnostic-*/SKILL.md"
      via: "Sequential skill invocation with findings collection"
      pattern: "diagnostic-core-integrity|diagnostic-config-security|diagnostic-user-audit|diagnostic-version-audit|diagnostic-malware-scan|diagnostic-code-quality"
    - from: "commands/diagnose/COMMAND.md"
      to: "skills/report-generator/SKILL.md"
      via: "Pass combined findings JSON to report generator"
      pattern: "report-generator"
    - from: "commands/diagnose/COMMAND.md"
      to: "sites.json"
      via: "Read site profiles for connection details and default site"
      pattern: "sites\\.json"
---

<objective>
Create the /diagnose command that orchestrates all diagnostic skills into a complete workflow with natural language invocation, three modes (full, security-only, code-only), inline progress feedback, skip-and-continue error recovery, and suggested next actions.

Purpose: This is the primary user-facing command that delivers the plugin's core value -- running comprehensive WordPress diagnostics and producing actionable reports.
Output: commands/diagnose/COMMAND.md (fully specified command workflow)
</objective>

<execution_context>
@/Users/robertli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robertli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-command-workflows/04-CONTEXT.md
@.planning/phases/04-command-workflows/04-RESEARCH.md
@commands/connect/COMMAND.md
@skills/report-generator/SKILL.md
@skills/diagnostic-core-integrity/SKILL.md
@skills/diagnostic-config-security/SKILL.md
@skills/diagnostic-user-audit/SKILL.md
@skills/diagnostic-version-audit/SKILL.md
@skills/diagnostic-malware-scan/SKILL.md
@skills/diagnostic-code-quality/SKILL.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create /diagnose command with full orchestration workflow</name>
  <files>commands/diagnose/COMMAND.md</files>
  <action>
Create commands/diagnose/COMMAND.md as a complete command specification following the same markdown structure as commands/connect/COMMAND.md and commands/status/COMMAND.md (YAML frontmatter with name, description, usage, then markdown sections).

The command must implement these sections:

**Frontmatter:**
```yaml
name: diagnose
description: Run diagnostic suite on a WordPress site with full, security-only, or code-only modes
usage: /diagnose [mode] [on site-name]
modes:
  - full (default): All 6 diagnostic skills
  - security-only: core-integrity, config-security, user-audit
  - code-only: code-quality, malware-scan
```

**Section 1: Natural Language Argument Parsing**
- Parse user input to extract mode and site name using grep/sed pattern matching
- Mode detection patterns (case-insensitive):
  - "security", "audit", "security only", "just security" -> security-only mode
  - "code", "quality", "code only", "just code" -> code-only mode
  - No mode keywords -> full mode (default)
- Site extraction: look for "on {site-name}" pattern
- Default site fallback: read from sites.json where is_default == true
- If no default site and no site specified: list available sites and exit with usage hint
- This is NOT a bash script -- it is instructions Claude follows. Write it as procedural steps Claude executes, similar to how /connect COMMAND.md is written.

**Section 2: Connection Verification & Auto-Connect**
- Check sites.json for the target site profile
- If site not found in sites.json: tell user to run /connect first
- If site found but local_path directory doesn't exist or is empty: auto-connect by running the /connect flow for that site (reference commands/connect/COMMAND.md)
- If site found and files exist: proceed to resync

**Section 3: Silent File Resync**
- Before running diagnostics, resync files from remote to ensure fresh data
- Use rsync with same exclusions as /connect (wp-content/uploads/, wp-content/cache/, etc.)
- Run quietly (no verbose file listing) -- only show "Syncing files..." and "Files synced" or error
- If resync fails: warn user but continue with cached files (do NOT abort)
- Detect rsync variant (openrsync vs GNU) same as /connect does

**Section 4: Skill Execution with Inline Progress**
- Determine skills to run based on mode:
  - full: diagnostic-core-integrity, diagnostic-config-security, diagnostic-user-audit, diagnostic-version-audit, diagnostic-malware-scan, diagnostic-code-quality
  - security-only: diagnostic-core-integrity, diagnostic-config-security, diagnostic-user-audit
  - code-only: diagnostic-code-quality, diagnostic-malware-scan
- For WP-CLI dependent skills (core-integrity, user-audit, version-audit): check if wp_cli_path is set in sites.json profile. If null/missing, skip these skills and note as "WP-CLI unavailable"
- Execute each skill sequentially. For each skill:
  1. Show: "Running {skill-display-name}..." (use human-friendly names like "Core Integrity Check" not "diagnostic-core-integrity")
  2. Execute the skill following its SKILL.md instructions
  3. Collect findings as JSON array
  4. On success: show "{skill-name}: {N} critical, {N} warning, {N} info"
  5. On failure (skill errors, SSH timeout, invalid JSON): mark as "skipped", show warning, continue to next skill
  6. If any critical findings: show them immediately inline (title + one-line summary only)
- Track: skills_completed list, skills_skipped list, combined_findings JSON array

**Section 5: Report Generation**
- Pass combined_findings to report-generator skill (reference skills/report-generator/SKILL.md)
- If any skills were skipped: pass "Incomplete" as the scan status so health grade shows "Incomplete" instead of A-F
- Report saves to memory/{site-name}/latest.md per report-generator's archive rotation logic

**Section 6: Completion Summary**
- After report generation, display inline summary:
  - Health grade (or "Incomplete" if skills skipped)
  - Finding counts: N critical, N warning, N info
  - Top 3 critical issues (title only) if any exist
  - Report file path: memory/{site-name}/latest.md
- If skills were skipped: list which skills were skipped and why

**Section 7: Suggested Next Actions**
- Based on findings, suggest concrete next actions:
  - Critical findings present: "Fix critical issues first" with specific commands if applicable (e.g., "wp core download --force" for modified core files, "disable WP_DEBUG in wp-config.php" for debug mode)
  - Many warnings (5+): "Update plugins and themes" if version-related, or category-specific advice
  - Healthy site (A or B grade): "Site is healthy. Schedule regular scans."
  - Incomplete scan: "Fix connectivity issues and re-run /diagnose"
  - Always end with: "Run /diagnose again after making changes to verify fixes."

**Section 8: Error Handling**
- Document error scenarios and how to handle each:
  - sites.json not found -> "No sites configured. Run /connect first."
  - Site not in sites.json -> "Site '{name}' not found. Available sites: {list}"
  - SSH connection fails during resync -> Warn, continue with cached files
  - All skills fail -> Show error summary, suggest checking connection
  - Report generation fails -> Show findings inline without saving to file

**Important implementation notes:**
- This is a CoWork plugin COMMAND.md -- it contains instructions for Claude to follow, NOT a bash script. Write it as procedural steps with bash code blocks for the actual commands Claude should run, same style as /connect COMMAND.md.
- Reference existing skills by their SKILL.md paths (skills/diagnostic-*/SKILL.md)
- Use jq for all JSON manipulation (finding aggregation, severity counting)
- Use the established finding format from report-generator SKILL.md (id, severity, category, title, summary, detail, location, fix)
- The /audit command is NOT separate -- per user decision, /audit is satisfied by /diagnose in security-only mode. Do NOT create a separate /audit command.
  </action>
  <verify>
Verify commands/diagnose/COMMAND.md exists and contains:
1. YAML frontmatter with name, description, usage, modes
2. Natural language parsing section with mode + site extraction
3. Auto-connect logic referencing /connect
4. Silent resync section
5. Skill execution loop with all 6 skills mapped to modes
6. Inline progress with finding counts and critical findings shown immediately
7. Skip-and-continue error recovery
8. Report generation referencing report-generator skill
9. Completion summary with health grade
10. Suggested next actions section
11. Error handling section
File should be 200+ lines.
  </verify>
  <done>
/diagnose COMMAND.md fully specifies the diagnostic workflow with three modes (full, security-only, code-only), NL argument parsing, auto-connect, inline progress, skip-and-continue error recovery, report generation, and suggested next actions. All 6 diagnostic skills are correctly mapped to their modes. The command reads as procedural instructions for Claude to execute, not as a standalone bash script.
  </done>
</task>

</tasks>

<verification>
- commands/diagnose/COMMAND.md exists with 200+ lines
- All three modes documented: full, security-only, code-only
- All 6 diagnostic skills referenced by correct path
- Report generator skill referenced for report compilation
- sites.json referenced for site profile lookup
- Natural language parsing covers: "security only", "just security", "audit", "code only", "on {site}"
- Error recovery documented (skip-and-continue pattern)
- Inline progress format specified (finding counts per skill, critical findings shown immediately)
- Suggested next actions section present
</verification>

<success_criteria>
/diagnose command is fully specified and ready for Claude to execute as a workflow. A user can say "/diagnose", "/diagnose security only", "/diagnose code only on mysite" and the command specification covers all these invocations with clear procedural steps.
</success_criteria>

<output>
After completion, create `.planning/phases/04-command-workflows/04-01-SUMMARY.md`
</output>
