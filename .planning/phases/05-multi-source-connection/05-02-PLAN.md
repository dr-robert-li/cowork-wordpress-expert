---
phase: 05-multi-source-connection
plan: 02
type: execute
wave: 2
depends_on:
  - "05-01"
files_modified:
  - commands/connect/COMMAND.md
  - commands/diagnose/COMMAND.md
  - commands/status/COMMAND.md
autonomous: true
requirements:
  - MSRC-06

must_haves:
  truths:
    - "Capability summary is shown at connection time listing which skill categories are available for the source type"
    - "/diagnose skips WP-CLI-dependent skills with inline explanation when source type lacks WP-CLI"
    - "/diagnose resync step is source-type-gated (SSH=rsync, local=skip, docker bind=skip, docker cp=re-copy, git=skip)"
    - "/status shows source type badge ([SSH], [LOCAL], [DOCKER], [GIT]) next to each profile"
    - "Inline skip messages during diagnostics explain why a skill was skipped and what the user can do"
  artifacts:
    - path: "commands/connect/COMMAND.md"
      provides: "Capability summary display at connection time"
      contains: "Capabilities for this connection"
    - path: "commands/diagnose/COMMAND.md"
      provides: "Source-type-gated resync and skill execution"
      contains: "source_type"
    - path: "commands/status/COMMAND.md"
      provides: "Source type badges in profile display"
      contains: "source_type"
  key_links:
    - from: "commands/diagnose/COMMAND.md"
      to: "sites.json"
      via: "reads source_type and wp_cli_path to gate skills"
      pattern: "source_type.*ssh"
    - from: "commands/status/COMMAND.md"
      to: "sites.json"
      via: "reads source_type for badge display"
      pattern: "source_type.*BADGE"
---

<objective>
Add capability gating, resync routing, and source type display across /connect, /diagnose, and /status so that non-SSH source types work correctly with the diagnostic workflow.

Purpose: Without this plan, /diagnose would attempt rsync and SSH-based WP-CLI commands on local/Docker/git sources and fail. Users need to see what's available at connection time, get clear skip messages during diagnostics, and see source type badges in /status.

Output: Updated commands for connect (capability summary), diagnose (resync gating + skill gating), and status (source badges).
</objective>

<execution_context>
@/Users/robertli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robertli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-multi-source-connection/05-RESEARCH.md
@.planning/phases/05-multi-source-connection/05-CONTEXT.md
@.planning/phases/05-multi-source-connection/05-01-SUMMARY.md
@commands/connect/COMMAND.md
@commands/diagnose/COMMAND.md
@commands/status/COMMAND.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add capability summary to /connect and source-type-gated resync + skill gating to /diagnose</name>
  <files>commands/connect/COMMAND.md, commands/diagnose/COMMAND.md</files>
  <action>
**Part A: Capability summary at connection time (commands/connect/COMMAND.md)**

At the END of each source type flow in /connect (after profile save, before hot cache update), add a capability summary display. This goes in ALL four flows (SSH, local, Docker, git).

The summary format:

```
Connected: [profile-name]  [SOURCE_TYPE_BADGE]

Capabilities for this connection:
  [x] Code quality analysis
  [x] Malware scan
  [x] WordPress configuration security
  [x/space] Database analysis — [reason if unavailable]
  [x/space] User account audit — [reason if unavailable]
  [x/space] Version audit — [reason if unavailable]
```

Logic for DB/WP-CLI-dependent capabilities:
- If wp_cli_path is set and not null → `[x]` (available)
- If wp_cli_path is null/empty:
  - source_type "git" → reason: "git source — no live WordPress database"
  - source_type "local" → reason: "WP-CLI not found locally — install wp-cli.org to enable"
  - source_type "docker" → reason: "WP-CLI not found in container"
  - source_type "ssh" → reason: "WP-CLI not installed on remote server"

After the summary, if any DB skills are unavailable, add a footer line:
- For git: "This source is for static code analysis only. For DB diagnostics, connect via SSH or Docker."
- For local without WP-CLI: "Install WP-CLI locally (wp-cli.org) to enable database diagnostics."
- For docker without WP-CLI: "Install WP-CLI in the container (wp-cli.org) to enable database diagnostics."

**Part B: Source-type-gated resync in /diagnose (commands/diagnose/COMMAND.md)**

Find the existing Section 3 in /diagnose (the "silent rsync resync" step that runs before diagnostics). Replace the unconditional rsync with source-type-gated logic:

1. Read source_type from profile: `jq -r '.source_type // "ssh"'`
2. Branch on source_type:
   - **ssh**: Run existing rsync resync logic (unchanged)
   - **local**: Skip resync entirely. Tell Claude: "Files are accessed directly from local filesystem — no resync needed."
   - **docker** with file_access "bind_mount": Skip resync. "Files accessed via bind mount — always current."
   - **docker** with file_access "docker_cp": Re-run `docker cp "${container}:${wp_path}/." "$local_path"` to get fresh files. Show: "Syncing files from container..."
   - **git**: Skip resync. Do NOT auto-pull. Tell Claude: "Git source — using existing local files. User can manually pull if needed."

**Part C: WP-CLI-dependent skill gating in /diagnose (commands/diagnose/COMMAND.md)**

Find the skill execution section in /diagnose. Before each WP-CLI-dependent skill runs, add a source_type + wp_cli_path check:

WP-CLI-dependent skills (identified from existing COMMAND.md — these use `ssh user@host wp ...` or similar WP-CLI commands):
- Core integrity check (uses `wp core verify-checksums`)
- User account audit (uses `wp user list`)
- Version audit (uses `wp core version`, `wp plugin list`, `wp theme list`)

For each WP-CLI skill, the gating logic:

1. Read wp_cli_path from profile
2. If wp_cli_path is null or empty:
   ```
   [Skill Name] Skipped — WP-CLI not available ([source_type] source).
   ```
   Add to skipped skills list. Continue to next skill.
3. If wp_cli_path exists but source_type is "docker":
   - Replace `ssh user@host wp ...` with `docker exec "$container_name" wp ...`
4. If source_type is "local" and wp_cli_path exists:
   - Replace `ssh user@host wp ...` with `wp --path="$wp_path" ...` (direct local WP-CLI)
5. If source_type is "ssh": use existing SSH-based WP-CLI invocation (unchanged)

**Critical:** The existing skill execution for SSH must not be broken. The source_type check wraps around the existing logic; it does not replace it. For SSH source_type, the code path is identical to what exists today.

The inline skip message format for diagnostic output:
```
[Core Integrity Check] Skipped — WP-CLI not available (git source). Connect via SSH or Docker with WP-CLI for this check.
```

At the end of the diagnostic run, if any skills were skipped, add a summary:
```
Note: [N] skill(s) skipped due to source type limitations.
Skipped: Core Integrity Check, User Account Audit, Version Audit
Reason: [source_type] source without WP-CLI access
```
  </action>
  <verify>
Read commands/connect/COMMAND.md:
1. Capability summary appears after profile save in all four source type flows
2. Summary correctly shows [x] for file-analysis skills and conditionally for DB skills

Read commands/diagnose/COMMAND.md:
3. Section 3 resync is gated by source_type (not unconditional rsync)
4. SSH resync path is identical to original
5. WP-CLI skills have gating check before execution
6. Docker source uses docker exec for WP-CLI commands
7. Local source uses direct wp --path for WP-CLI commands
8. Skip messages include source type and actionable guidance
  </verify>
  <done>
/connect shows a capability summary after every connection. /diagnose gates resync by source type and gates WP-CLI skills by wp_cli_path availability. Inline skip messages explain why skills were skipped and suggest how to enable them.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add source type badges and sync status to /status command</name>
  <files>commands/status/COMMAND.md</files>
  <action>
Update the /status COMMAND.md to display source type information for each site profile.

**Source type badge:**

When listing site profiles, add a badge after the profile name:

```
### local-dev  [LOCAL]  [DEFAULT]
### docker-wp  [DOCKER]
### git-theme-review  [GIT]
### production  [SSH]
```

Badge logic — read source_type from profile (`jq -r '.source_type // "ssh"'`):
- "ssh" → `[SSH]`
- "local" → `[LOCAL]`
- "docker" → `[DOCKER]`
- "git" → `[GIT]`

**Source-specific detail lines:**

After the badge, add source-type-specific info in the profile detail section:

For SSH (existing — add "Source:" line):
```
- Source: SSH (user@host)
```

For Local:
```
- Source: local directory
- Path: /Users/robertli/sites/mysite
```

For Docker:
```
- Source: docker container ([container_name])
- File access: [bind_mount|docker_cp]
- Container WP path: [wp_path inside container]
```

For Git:
```
- Source: git repository
- Remote: [git_remote] ([git_branch])
- Clone: [local_path]
```

**Sync status display:**

Replace the existing "Last sync:" display with source-type-aware text:
- SSH: "Last sync: [timestamp]" (existing behavior)
- Local: "Files: live access (no sync needed)"
- Docker (bind_mount): "Files: live access via bind mount"
- Docker (docker_cp): "Last sync: [timestamp] (docker cp)"
- Git: "Files: local clone ([timestamp])"

**Available capabilities line:**

Add a single line showing capability coverage:
```
- Capabilities: code quality, malware scan, config security[, database, user audit, version audit]
```
The bracketed items only appear if wp_cli_path is set. If not, append: "(DB skills unavailable — [reason])"

**Read new fields from sites.json:**

Read the new profile fields with null-safe defaults:
```bash
SOURCE_TYPE=$(echo "$SITE_DATA" | jq -r '.source_type // "ssh"')
CONTAINER_NAME=$(echo "$SITE_DATA" | jq -r '.container_name // empty')
GIT_REMOTE=$(echo "$SITE_DATA" | jq -r '.git_remote // empty')
GIT_BRANCH=$(echo "$SITE_DATA" | jq -r '.git_branch // empty')
FILE_ACCESS=$(echo "$SITE_DATA" | jq -r '.file_access // "rsync"')
```
  </action>
  <verify>
Read commands/status/COMMAND.md:
1. Source type badges ([SSH], [LOCAL], [DOCKER], [GIT]) appear next to profile names
2. Source-specific detail lines are present for each type
3. Sync status is source-type-aware (live access vs timestamp)
4. Capabilities line shows available skills
5. New profile fields are read with null-safe jq defaults
  </verify>
  <done>
/status displays source type badges, source-specific details (container name, git remote, local path), source-aware sync status, and capability coverage for each profile.
  </done>
</task>

</tasks>

<verification>
1. Read all three COMMAND.md files — verify source_type handling is consistent across connect, diagnose, and status
2. Verify /diagnose does NOT attempt rsync for non-SSH sources
3. Verify /diagnose does NOT attempt SSH-based WP-CLI for non-SSH sources
4. Verify /diagnose uses docker exec for Docker sources and direct wp for local sources
5. Verify /status badges match source_type values in sites.json
6. Verify capability summary at connection time matches the gating logic in /diagnose (same skills gated in both places)
7. Verify all skill skip messages include the source type and actionable guidance
</verification>

<success_criteria>
Capability gating is consistent: what /connect shows as unavailable, /diagnose actually skips. Resync is source-type-aware. /status displays source type badges and source-specific details. No SSH commands are attempted for non-SSH sources.
</success_criteria>

<output>
After completion, create `.planning/phases/05-multi-source-connection/05-02-SUMMARY.md`
</output>
