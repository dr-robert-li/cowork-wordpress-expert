---
phase: 06-database-health-infrastructure-audits
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - skills/diagnostic-db-autoload/SKILL.md
  - skills/diagnostic-db-transients/SKILL.md
  - skills/diagnostic-db-revisions/SKILL.md
autonomous: true
requirements:
  - DBHL-01
  - DBHL-02
  - DBHL-03
  - DBHL-04
  - DBHL-05

must_haves:
  truths:
    - "Autoload skill queries total autoload size and lists all options above 10KB threshold sorted by size with plugin attribution"
    - "Autoload skill uses Warning at 900KB and Critical above 2MB thresholds"
    - "Transient skill counts live and expired transients using wp db query with UNIX_TIMESTAMP() comparison (not wp transient list --expired)"
    - "Transient skill uses ratio-based severity (expired:live ratio) not raw counts"
    - "Revision skill counts revisions per post type and checks WP_POST_REVISIONS constant for unlimited setting"
    - "All three skills get table prefix dynamically via wp db prefix (never hardcoded wp_)"
    - "All three skills use WP_CLI_PREFIX pattern for all WP-CLI invocations (never parse wp-config.php)"
  artifacts:
    - path: "skills/diagnostic-db-autoload/SKILL.md"
      provides: "Autoload bloat analysis skill"
      contains: "WP_CLI_PREFIX"
    - path: "skills/diagnostic-db-transients/SKILL.md"
      provides: "Transient buildup detection skill"
      contains: "UNIX_TIMESTAMP"
    - path: "skills/diagnostic-db-revisions/SKILL.md"
      provides: "Post revision analysis skill"
      contains: "WP_POST_REVISIONS"
  key_links:
    - from: "skills/diagnostic-db-autoload/SKILL.md"
      to: "WP_CLI_PREFIX"
      via: "wp db prefix and wp db query"
      pattern: "WP_CLI_PREFIX.*db"
    - from: "skills/diagnostic-db-transients/SKILL.md"
      to: "WP_CLI_PREFIX"
      via: "wp db query with transient timeout comparison"
      pattern: "_transient_timeout_.*UNIX_TIMESTAMP"
    - from: "skills/diagnostic-db-revisions/SKILL.md"
      to: "WP_CLI_PREFIX"
      via: "wp post list and wp config get"
      pattern: "WP_CLI_PREFIX.*post list.*revision"
---

<objective>
Create three database health diagnostic skills that analyze WordPress wp_options autoload bloat, transient buildup, and post revision accumulation.

Purpose: Enable users to identify database health issues that degrade WordPress performance — bloated autoload data, expired transient buildup, and uncapped revision accumulation.

Output: Three new SKILL.md files in skills/diagnostic-db-autoload/, skills/diagnostic-db-transients/, and skills/diagnostic-db-revisions/
</objective>

<execution_context>
@/Users/robertli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robertli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-database-health-infrastructure-audits/06-RESEARCH.md
@skills/diagnostic-version-audit/SKILL.md
@commands/diagnose/COMMAND.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create autoload bloat analysis skill</name>
  <files>skills/diagnostic-db-autoload/SKILL.md</files>
  <action>
Create `skills/diagnostic-db-autoload/SKILL.md` following the exact structure of existing diagnostic skills (use diagnostic-version-audit as template for frontmatter, section layout, finding JSON format).

**Skill content must include:**

1. **Frontmatter:** name: diagnostic-db-autoload, description of autoload bloat analysis.

2. **Overview:** Explains what autoload bloat is and why it matters (wp_options autoload='yes' loaded on every page).

3. **Prerequisites:** Site connection profile, WP_CLI_PREFIX set by /diagnose, WP_CLI_AVAILABLE=true.

4. **Dynamic table prefix retrieval:**
   ```bash
   TABLE_PREFIX=$($WP_CLI_PREFIX db prefix 2>/dev/null | tr -d '[:space:]')
   ```
   With fallback to `$WP_CLI_PREFIX config get table_prefix` if empty. If both fail, return a Warning finding and exit.

5. **Check 1: Total autoload size** — `wp db query` with `SELECT COALESCE(SUM(LENGTH(option_value)), 0) FROM ${TABLE_PREFIX}options WHERE autoload='yes'` using `--skip-column-names`. Convert to KB for display.

6. **Severity thresholds (per user decision):**
   - Above 2MB (2097152 bytes) = Critical
   - Above 900KB (921600 bytes) = Warning
   - Below 900KB = Info (healthy)

7. **Check 2: Autoload offenders** — All options above 10KB (10240 bytes): `SELECT option_name, LENGTH(option_value) as size_bytes FROM ${TABLE_PREFIX}options WHERE autoload='yes' AND LENGTH(option_value) > 10240 ORDER BY size_bytes DESC` with `--skip-column-names`.

8. **Plugin attribution via prefix matching** — Inline associative array of known plugin prefixes (from research: wpseo_, rank_math_, elementor_, woocommerce_, wpforms_, tribe_, acf_, vc_, gtm4wp_, litespeed_, jetpack_, wordfence_, updraftplus_, gravityforms, gform_, etc.). For each option_name, check prefix match. If no match, show "Unknown ({prefix}_*)". Output as flat list sorted by size with columns: Option Name | Size | Attribution.

9. **Finding IDs:** DBHL-AUTOLD-SZ for total size finding, DBHL-AUTOLD-OFF for offenders list.

10. **Finding JSON format** matching existing skills: id, severity, category ("Database Health"), title, summary (plain language), detail (technical), location, fix.

11. **Multisite note:** Document that on Multisite, this checks the primary site's options table only.

**Important constraints (DBHL-04, DBHL-05):**
- NEVER hardcode `wp_` — always use `${TABLE_PREFIX}`
- NEVER parse wp-config.php — all DB access through `$WP_CLI_PREFIX`
- Always use `--skip-column-names` and pipe through `tr -d '[:space:]'` for scalar values
  </action>
  <verify>File exists at skills/diagnostic-db-autoload/SKILL.md. Contains: WP_CLI_PREFIX, TABLE_PREFIX (dynamic), 921600, 2097152, --skip-column-names, DBHL-AUTOLD-SZ, DBHL-AUTOLD-OFF, plugin prefix mapping dictionary, autoload='yes'. Does NOT contain hardcoded "wp_options" (must use ${TABLE_PREFIX}options).</verify>
  <done>Autoload bloat SKILL.md exists with dynamic table prefix, two severity thresholds (900KB Warning, 2MB Critical), all options above 10KB listed with plugin attribution via prefix matching, and proper WP_CLI_PREFIX usage throughout.</done>
</task>

<task type="auto">
  <name>Task 2: Create transient buildup detection skill</name>
  <files>skills/diagnostic-db-transients/SKILL.md</files>
  <action>
Create `skills/diagnostic-db-transients/SKILL.md` following the same structure as Task 1.

**Skill content must include:**

1. **Frontmatter:** name: diagnostic-db-transients, description of transient buildup detection.

2. **Overview:** Explains what WordPress transients are and why expired buildup matters.

3. **Prerequisites:** Same as autoload skill.

4. **Dynamic table prefix:** Same pattern as autoload skill.

5. **Check 1: Live transient count** — `SELECT COUNT(*) FROM ${TABLE_PREFIX}options WHERE option_name LIKE '_transient_%' AND option_name NOT LIKE '_transient_timeout_%'` with `--skip-column-names`.

6. **Check 2: Expired transient count** — CRITICAL: Do NOT use `wp transient list --expired` (the --expired flag does not exist). Use direct SQL: `SELECT COUNT(*) FROM ${TABLE_PREFIX}options WHERE option_name LIKE '_transient_timeout_%' AND CAST(option_value AS UNSIGNED) < UNIX_TIMESTAMP()` with `--skip-column-names`.

7. **Check 3: Total transient storage size** — `SELECT COALESCE(SUM(LENGTH(option_value)), 0) FROM ${TABLE_PREFIX}options WHERE option_name LIKE '_transient_%'` with `--skip-column-names`.

8. **Ratio-based severity (per user decision — ratio, not raw count):**
   - expired > 50% of live count AND expired > 100 absolute = Warning
   - expired > 25% of live count AND expired > 50 absolute = Info (noting cleanup recommended)
   - Otherwise = Info (healthy)
   - Use `awk "BEGIN {printf \"%.2f\", $EXPIRED_COUNT / $LIVE_COUNT}"` for float division
   - Handle division by zero (LIVE_COUNT=0)

9. **Output format:** Aggregate counts only (per user decision — no individual transient listing). Show: live count, expired count, expired-to-live ratio percentage, total size.

10. **Finding IDs:** DBHL-TRANS-EXP for expired transient ratio finding, DBHL-TRANS-OK for healthy state.

11. **Fix guidance:** Recommend `wp transient delete --expired` to clear expired transients safely.

**Same DBHL-04/DBHL-05 constraints as Task 1.**
  </action>
  <verify>File exists at skills/diagnostic-db-transients/SKILL.md. Contains: UNIX_TIMESTAMP, _transient_timeout_, ratio calculation with awk, --skip-column-names, DBHL-TRANS-EXP, DBHL-TRANS-OK, "wp transient delete --expired" in fix text. Does NOT contain "wp transient list --expired" or hardcoded "wp_options".</verify>
  <done>Transient buildup SKILL.md exists using direct SQL with UNIX_TIMESTAMP() for expired detection, ratio-based severity, aggregate counts only, and proper WP_CLI_PREFIX usage.</done>
</task>

<task type="auto">
  <name>Task 3: Create post revision analysis skill</name>
  <files>skills/diagnostic-db-revisions/SKILL.md</files>
  <action>
Create `skills/diagnostic-db-revisions/SKILL.md` following the same structure.

**Skill content must include:**

1. **Frontmatter:** name: diagnostic-db-revisions, description of post revision accumulation analysis.

2. **Overview:** Explains how WordPress stores revisions and why uncapped revisions bloat the database.

3. **Prerequisites:** Same as other DB skills.

4. **Dynamic table prefix:** Same pattern.

5. **Check 1: Total revision count** — `$WP_CLI_PREFIX post list --post_type=revision --format=count`.

6. **Check 2: Per-parent post type breakdown** — `SELECT p.post_type, COUNT(r.ID) as revisions FROM ${TABLE_PREFIX}posts r JOIN ${TABLE_PREFIX}posts p ON r.post_parent = p.ID WHERE r.post_type = 'revision' GROUP BY p.post_type ORDER BY revisions DESC` with `--skip-column-names`.

7. **Check 3: WP_POST_REVISIONS constant** — `$WP_CLI_PREFIX config get WP_POST_REVISIONS`. Handle all four cases explicitly:
   - Empty/error = not defined = unlimited (WordPress default)
   - "true" = explicitly unlimited
   - "false" = disabled (0 revisions)
   - A number = limit set

8. **Check 4: Post count for context** — `SELECT COUNT(*) FROM ${TABLE_PREFIX}posts WHERE post_type NOT IN ('revision','attachment','nav_menu_item') AND post_status NOT IN ('auto-draft','trash')` for average revisions-per-post calculation.

9. **Severity logic:**
   - WP_POST_REVISIONS unlimited AND total revisions > 1000 = Warning
   - Total revisions > 5000 regardless = Warning
   - Total revisions > 500 or high per-post average = Info (with recommendation)
   - Otherwise = Info (healthy)

10. **Savings estimate:** If unlimited, estimate savings from setting limit to 10: `(TOTAL_REVISIONS - (POST_COUNT * 10))` excess rows, estimate ~2KB per row for byte savings.

11. **Recommended limit:** 10 revisions per post (per user context suggestion). Recommend adding `define('WP_POST_REVISIONS', 10);` to wp-config.php.

12. **Finding IDs:** DBHL-REV-UNL for unlimited revisions, DBHL-REV-CNT for high count, DBHL-REV-OK for healthy.

**Same DBHL-04/DBHL-05 constraints.**
  </action>
  <verify>File exists at skills/diagnostic-db-revisions/SKILL.md. Contains: WP_POST_REVISIONS, post_type=revision, per-parent breakdown query, savings estimate logic, --skip-column-names, DBHL-REV-UNL, DBHL-REV-CNT, "define('WP_POST_REVISIONS', 10)". Does NOT contain hardcoded "wp_posts" (must use ${TABLE_PREFIX}posts).</verify>
  <done>Post revision SKILL.md exists with total count, per-type breakdown, WP_POST_REVISIONS check (all 4 value cases handled), savings estimate, and recommendation for limit of 10.</done>
</task>

</tasks>

<verification>
For all three skills:
1. Every SQL query uses `${TABLE_PREFIX}` — never hardcoded `wp_`
2. Every WP-CLI call uses `$WP_CLI_PREFIX` — never direct `ssh` or `wp` commands
3. Every `wp db query` for scalar values includes `--skip-column-names` and `| tr -d '[:space:]'`
4. Finding JSON matches existing skill format (id, severity, category, title, summary, detail, location, fix)
5. Severity levels are only Critical, Warning, Info (3-level system)
6. No `wp transient list --expired` anywhere in transients skill
</verification>

<success_criteria>
Three SKILL.md files exist, each following the established diagnostic skill pattern, using dynamic table prefix via wp db prefix, routing all DB access through WP_CLI_PREFIX, and producing JSON findings with deterministic IDs.
</success_criteria>

<output>
After completion, create `.planning/phases/06-database-health-infrastructure-audits/06-01-SUMMARY.md`
</output>
