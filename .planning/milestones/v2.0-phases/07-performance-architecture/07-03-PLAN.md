---
phase: 07-performance-architecture
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - skills/diagnostic-architecture/SKILL.md
autonomous: true
requirements:
  - ARCH-01
  - ARCH-02

must_haves:
  truths:
    - "User can detect CPTs registered in custom code that have zero or very few published posts (dead CPTs)"
    - "User can detect CPTs registered in custom code that have excessive row counts (possible data-store misuse)"
    - "CPT row count checks use live WP-CLI data but skill runs partial results when WP-CLI is unavailable (static analysis still runs)"
    - "User can detect hooks with >20 callbacks registered on them from custom code"
    - "User can detect expensive function calls (new WP_Query, $wpdb->query) registered on 'init' or 'wp_loaded' in custom code"
    - "User can detect same hook+priority combination registered from multiple different plugin files"
    - "User can detect caching anti-patterns: missing persistent object cache, transients with 0 expiry (permanent storage misuse)"
    - "All checks scope to custom code only — well-known third-party plugins skipped"
  artifacts:
    - path: "skills/diagnostic-architecture/SKILL.md"
      provides: "Architecture review: CPT misuse, hook abuse, caching anti-patterns"
      contains: "ARCH-CPT"
  key_links:
    - from: "skills/diagnostic-architecture/SKILL.md"
      to: "WP-CLI post-type list + post list --format=count"
      via: "$WP_CLI_PREFIX post-type list --format=json"
      pattern: "WP_CLI_PREFIX"
    - from: "skills/diagnostic-architecture/SKILL.md"
      to: ".sites/{site}/wp-content/plugins/"
      via: "grep add_action/add_filter on synced PHP files"
      pattern: "add_action|add_filter"
---

<objective>
Create the diagnostic-architecture skill covering CPT misuse detection (ARCH-01), hook abuse patterns (ARCH-02), and caching anti-patterns. This is a mixed skill: CPT row counts require WP-CLI, while hook abuse and caching analysis are static grep on synced PHP files. The skill self-gates its WP-CLI checks independently — when WP-CLI is unavailable, grep-based checks still run.

Purpose: Architecture-level patterns (CPT misuse, hook overloading, missing caches) compound over time and are invisible to users without code analysis tooling. Early detection prevents expensive refactors.

Output: skills/diagnostic-architecture/SKILL.md
</objective>

<execution_context>
@/Users/robertli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robertli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-performance-architecture/07-RESEARCH.md
@skills/diagnostic-code-quality/SKILL.md
@skills/diagnostic-db-autoload/SKILL.md
@skills/diagnostic-https-audit/SKILL.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create diagnostic-architecture SKILL.md</name>
  <files>skills/diagnostic-architecture/SKILL.md</files>
  <action>
Create `skills/diagnostic-architecture/SKILL.md` covering three architecture domains. Use `skills/diagnostic-https-audit/SKILL.md` as the model for a mixed skill (some checks need WP-CLI, some don't — each section self-gates independently). Use `skills/diagnostic-code-quality/SKILL.md` for the WP.org plugin skip list pattern.

**Skill Identity (frontmatter):**
```yaml
---
name: diagnostic-architecture
description: Reviews WordPress architecture for CPT misuse patterns (dead CPTs, data-store abuse via row count gating), hook abuse (excessive callbacks, expensive init hooks, priority conflicts), and caching anti-patterns (missing persistent object cache, permanent transients). CPT checks require WP-CLI; hook and cache checks are static analysis on synced files. Each section self-gates independently.
---
```

**Overview section:** Architecture issues are slow-burn problems — individually small, collectively severe. A CPT used as a data store with 50,000 rows breaks pagination and export tools. Fifty callbacks on 'init' delay every page load. Missing object cache means every repeat lookup hits MySQL. This skill surfaces these patterns early.

**Target Directories (for grep-based checks):**
```bash
LOCAL_PATH  # from sites.json (loaded by /diagnose)
THEME_DIR="${LOCAL_PATH}/wp-content/themes"
PLUGIN_DIR="${LOCAL_PATH}/wp-content/plugins"
```

**WP.org Plugin Skip List:** Same list as diagnostic-performance-n1 and diagnostic-code-quality. Apply to PLUGIN_DIR subdirectory names. Note how many were skipped in findings' detail fields.

---

**Part A: CPT Misuse Detection (requires WP-CLI)**

Self-gate — if WP-CLI unavailable, emit one Info finding and skip Part A entirely (Parts B and C still run):
```bash
if [ "$WP_CLI_AVAILABLE" != "true" ]; then
  CPT_SKIP_FINDING='{"id":"ARCH-CPT-SKIP","severity":"Info","category":"Architecture","title":"CPT analysis skipped — WP-CLI not available","summary":"CPT row count analysis requires WP-CLI to query the database.","detail":"Static hook abuse and caching anti-pattern checks will still run.","location":"wp post-type list","fix":"Connect via SSH or Docker with WP-CLI to enable CPT row count analysis."}'
  # Append to findings array and continue to Part B
fi
```

Step 1 — Get all registered custom (non-builtin) post types:
```bash
CPT_LIST=$($WP_CLI_PREFIX post-type list \
  --fields=name,label,_builtin \
  --format=json 2>/dev/null | \
  jq '[.[] | select(._builtin == false or ._builtin == "false")]')
```

Step 2 — For each custom CPT, get row count AND check if it's registered in custom code:
```bash
# For each CPT name in CPT_LIST:
CPT_NAME="..."  # extracted from jq loop

POST_COUNT=$($WP_CLI_PREFIX post list \
  --post_type="$CPT_NAME" \
  --post_status=any \
  --format=count 2>/dev/null | tr -d '[:space:]')

# Check if this CPT is registered in custom code (grep for register_post_type in themes/plugins)
CPT_IN_CUSTOM=$(grep -rn "register_post_type\s*(\s*['\"]${CPT_NAME}['\"]" \
  "$THEME_DIR" "$PLUGIN_DIR" \
  --include="*.php" 2>/dev/null | grep -v "$(echo "$WELL_KNOWN_PLUGIN_DIRS" | tr ' ' '\n' | sed 's|^|plugins/|' | tr '\n' '\|')" | head -1)

# If CPT not found in custom code — skip it (third-party CPT)
[ -z "$CPT_IN_CUSTOM" ] && continue
```

**CPT Misuse Thresholds (Claude's discretion):**
- Dead CPT: 0 published posts → Warning (registered but unused)
- Very few posts: 1-5 posts → Info (possibly orphaned or just created)
- Excessive rows (potential data-store misuse): > 10,000 posts → Warning with note that this may be intentional

Finding ID format: `ARCH-CPT-{hash}` where hash is MD5 of CPT name, truncated to 6 chars.

Example finding (dead CPT):
```json
{
  "id": "ARCH-CPT-a3f2b1",
  "severity": "Warning",
  "category": "Architecture",
  "title": "Dead CPT: 'event_log' has 0 published posts",
  "summary": "A custom post type is registered but has never been used and may be orphaned code.",
  "detail": "Post type 'event_log' is registered at: themes/mytheme/includes/cpts.php:45\nPublished post count: 0 (any status: 0)\nThis CPT appears to be unused. Dead CPTs consume memory on every request as WordPress loads their registration.",
  "location": "themes/mytheme/includes/cpts.php:45",
  "fix": "If this CPT is no longer needed, remove the register_post_type() call. If it's in active development, add at least one test entry to confirm it works. If it belongs to a deactivated plugin, the registration code should have been removed."
}
```

Example finding (excessive rows):
```json
{
  "id": "ARCH-CPT-b7c4d2",
  "severity": "Warning",
  "category": "Architecture",
  "title": "CPT 'api_log' has 14,523 posts — possible data-store misuse",
  "summary": "A custom post type has an unusually high row count, suggesting it may be used as a data store rather than as content.",
  "detail": "Post type 'api_log' is registered at: plugins/my-plugin/includes/logging.php:23\nPublished post count: 14,523\nThe WordPress posts table is optimized for content (pages, posts, products) not high-volume logging or data storage. Using CPTs for logging causes wp_posts table bloat.",
  "location": "plugins/my-plugin/includes/logging.php:23",
  "fix": "If this CPT is storing logs or transactional data, migrate to a custom database table using $wpdb->create_table(). The wp_posts table lacks the indexes needed for efficient high-volume data queries."
}
```

---

**Part B: Hook Abuse Detection (static grep — always runs)**

This section always runs regardless of WP-CLI availability (self-contained grep analysis).

**B1 — Count callbacks per hook across all custom code:**
```bash
# Extract all hook names from add_action/add_filter calls
# Count occurrences per hook name
# Report hooks with >20 registrations (Claude's discretion: threshold for "excessive")
HOOK_COUNTS=$(grep -rh "add_action\|add_filter" \
  "$THEME_DIR" "$PLUGIN_DIR" \
  --include="*.php" 2>/dev/null | \
  grep -oP "(?<=add_action\s*\(\s*['\"])[^'\"]+|(?<=add_filter\s*\(\s*['\"])[^'\"]+" | \
  sort | uniq -c | sort -rn | \
  awk '$1 >= 20 {print}')
```

Finding ID: `ARCH-HOOK-{hash}` (hash of hook name). Severity: Warning if >20 callbacks, Info if 10-20.

**B2 — Expensive operations on 'init' or 'wp_loaded':**
```bash
# Find add_action on init/wp_loaded, then AI checks what the callback does
INIT_HOOKS=$(grep -rn "add_action\s*(\s*['\"]init['\"]" \
  "$THEME_DIR" "$PLUGIN_DIR" \
  --include="*.php" -A 3 2>/dev/null)

WP_LOADED_HOOKS=$(grep -rn "add_action\s*(\s*['\"]wp_loaded['\"]" \
  "$THEME_DIR" "$PLUGIN_DIR" \
  --include="*.php" -A 3 2>/dev/null)
```

AI reads 3 lines after each match. Flag as Warning if callback body (within 10 lines) contains:
- `new WP_Query`
- `$wpdb->query` or `$wpdb->get_results`
- `wp_remote_get` or `wp_remote_post` (HTTP requests on init)
- `file_get_contents` or `curl_exec`

Finding ID: `ARCH-HOOK-INIT-{hash}`. Severity: Warning.

**B3 — Same hook+priority from multiple plugin files:**
```bash
# Find add_action/add_filter with explicit priority, check for conflicts
# Pattern: add_action('hook_name', 'callback', 10) from different files
grep -rn "add_action\|add_filter" \
  "$THEME_DIR" "$PLUGIN_DIR" \
  --include="*.php" 2>/dev/null | \
  grep -oP "(?<=['\"])[^'\"]+(?=['\"])" | \
  # Group by hook+priority, flag where >1 file contributes
  sort | uniq -d
```

For priority conflict findings: AI identifies same hook+priority pairs that appear in more than one file. Finding ID: `ARCH-HOOK-PRI-{hash}`. Severity: Warning. Note in finding detail which files have the conflict.

**B3 clean finding:** If no hook abuse detected across all three checks:
```json
{
  "id": "ARCH-HOOK-OK",
  "severity": "Info",
  "category": "Architecture",
  "title": "Hook registration patterns are healthy",
  "summary": "No excessive callbacks, expensive init hooks, or priority conflicts detected in custom code.",
  "detail": "Analyzed add_action/add_filter calls in custom themes and plugins. All hooks have reasonable callback counts and no expensive operations detected on early hooks.",
  "location": "wp-content/themes/, wp-content/plugins/ (custom code only)",
  "fix": "No action required."
}
```

---

**Part C: Caching Anti-Patterns (mixed: WP-CLI for cache type, grep for code patterns)**

**C1 — Persistent object cache check:**
```bash
if [ "$WP_CLI_AVAILABLE" == "true" ]; then
  CACHE_TYPE=$($WP_CLI_PREFIX cache type 2>/dev/null | tr -d '[:space:]')
  # Returns "Default" if no persistent cache, or "Redis", "Memcached", "APCu", etc.
else
  # Fallback: check for object-cache.php drop-in file
  if [ -f "${LOCAL_PATH}/wp-content/object-cache.php" ]; then
    CACHE_TYPE="drop-in"
  else
    CACHE_TYPE="Default"
  fi
fi
```

If CACHE_TYPE is "Default" (or drop-in not found): Info finding suggesting persistent object cache.
Finding ID: `ARCH-CACHE-OBJ`.

**C2 — Permanent transient misuse (set_transient with 0 expiry):**
```bash
# 0 expiry = permanent storage — anti-pattern (use options table instead)
grep -rn "set_transient\s*(" \
  "$THEME_DIR" "$PLUGIN_DIR" \
  --include="*.php" -A 2 2>/dev/null | \
  grep -E "set_transient\s*\([^,]+,[^,]+,\s*0\s*\)"
```

Finding ID: `ARCH-CACHE-PERM-{hash}`. Severity: Warning. Fix: use `add_option()` with `autoload=no` for permanent storage instead.

**C3 — Direct DB queries that could use transients (heuristic):**
```bash
# Look for $wpdb->get_results calls in frontend contexts (functions.php, template files)
# that are not already wrapped in get_transient/set_transient
grep -rn "\\\$wpdb->get_results\|\\\$wpdb->get_row" \
  "$THEME_DIR" "$PLUGIN_DIR" \
  --include="*.php" -B 5 -A 5 2>/dev/null | \
  # Filter: only flag those NOT near get_transient/set_transient calls
  # AI reads context to confirm no transient wrapping
```

Finding ID: `ARCH-CACHE-DB-{hash}`. Severity: Info (heuristic — may be intentional).

All findings use standard 8-field format. Category: `"Architecture"`.
  </action>
  <verify>Read skills/diagnostic-architecture/SKILL.md and verify: (1) Part A self-gates on WP-CLI but Parts B and C run regardless, (2) CPT dead CPT threshold is 0 posts (Warning), excessive is >10,000 (Warning), (3) CPT check cross-references custom code grep before flagging any CPT, (4) hook abuse threshold is >20 callbacks (Warning), (5) init/wp_loaded expensive operations check present (WP_Query, $wpdb->query, HTTP calls), (6) caching anti-patterns: wp cache type check with local file fallback, set_transient 0-expiry pattern, (7) finding IDs: ARCH-CPT-{hash}, ARCH-HOOK-{hash}, ARCH-CACHE-{hash}.</verify>
  <done>skills/diagnostic-architecture/SKILL.md exists covering all three architecture domains with independent gating: CPT misuse (WP-CLI gated), hook abuse (always runs), caching anti-patterns (mixed). Custom-code-only scope enforced via WP.org skip list and grep cross-reference.</done>
</task>

</tasks>

<verification>
1. skills/diagnostic-architecture/ directory exists with SKILL.md
2. Part A (CPT misuse) self-gates on WP-CLI but emits skip finding and continues to Parts B/C
3. CPT detection filters to custom-code-only CPTs via grep cross-reference
4. Dead CPT = 0 posts → Warning; 1-5 posts → Info; >10,000 posts → Warning
5. Part B (hook abuse) always runs — pure grep on synced files
6. >20 callbacks threshold triggers Warning
7. Expensive ops on init/wp_loaded flagged (WP_Query, wpdb, HTTP requests)
8. Part C caching: wp cache type with object-cache.php fallback, set_transient 0 detection
9. All finding IDs follow ARCH-{check}-{hash} format
10. Category field is "Architecture" for all findings
</verification>

<success_criteria>
The architecture skill exists as a complete specification covering CPT misuse (with DB row count gating), hook abuse patterns (callback count, expensive init hooks, priority conflicts), and caching anti-patterns (no persistent cache, permanent transients). Custom-code-only scope enforced throughout. Partial results produced when WP-CLI unavailable.
</success_criteria>

<output>
After completion, create `.planning/phases/07-performance-architecture/07-03-SUMMARY.md`
</output>
