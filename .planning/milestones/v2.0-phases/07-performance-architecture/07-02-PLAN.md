---
phase: 07-performance-architecture
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - skills/diagnostic-cron-analysis/SKILL.md
  - skills/diagnostic-wpcli-profile/SKILL.md
autonomous: true
requirements:
  - PERF-02
  - PERF-03

must_haves:
  truths:
    - "User can see all wp-cron events that are overdue by more than 1 hour"
    - "User can see duplicate wp-cron hooks (same hook name registered more than once)"
    - "User can see cron events with intervals under 5 minutes (300 seconds)"
    - "When WP-CLI Profile is unavailable, each skipped check (stage profiling, hook timing) appears as a separate Info finding"
    - "When WP-CLI Profile is unavailable, user is asked 'Install it now?' before any install attempt"
    - "When WP-CLI Profile is available, user sees stage breakdown (bootstrap/main_query/template times) and top 5 slowest hooks in bootstrap stage"
    - "Both skills self-gate on WP_CLI_AVAILABLE=false and emit skip findings rather than failing"
    - "Cron date comparison handles macOS vs Linux date command differences"
  artifacts:
    - path: "skills/diagnostic-cron-analysis/SKILL.md"
      provides: "wp-cron event analysis (overdue, duplicate, excessive frequency)"
      contains: "PERF-CRON"
    - path: "skills/diagnostic-wpcli-profile/SKILL.md"
      provides: "WP-CLI Profile integration with graceful degradation"
      contains: "PERF-PROF"
  key_links:
    - from: "skills/diagnostic-cron-analysis/SKILL.md"
      to: "WP-CLI cron event list"
      via: "$WP_CLI_PREFIX cron event list --fields=hook,next_run_gmt,interval --format=json"
      pattern: "WP_CLI_PREFIX"
    - from: "skills/diagnostic-wpcli-profile/SKILL.md"
      to: "wp-cli/profile-command"
      via: "$WP_CLI_PREFIX profile --help exit code check"
      pattern: "PROFILE_AVAILABLE"
---

<objective>
Create two WP-CLI-dependent skills: diagnostic-cron-analysis (PERF-02) for wp-cron event health and diagnostic-wpcli-profile (PERF-03) for runtime performance timing with graceful degradation when wp-cli/profile-command is not installed.

Purpose: Cron events accumulate silently — overdue jobs, duplicates, and excessive frequencies are invisible without tooling. WP-CLI Profile reveals actual PHP execution time by hook and stage, but is an optional package requiring careful install handling.

Output: Two SKILL.md files in their respective directories
</objective>

<execution_context>
@/Users/robertli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robertli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-performance-architecture/07-RESEARCH.md
@skills/diagnostic-db-autoload/SKILL.md
@skills/diagnostic-https-audit/SKILL.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create diagnostic-cron-analysis SKILL.md</name>
  <files>skills/diagnostic-cron-analysis/SKILL.md</files>
  <action>
Create `skills/diagnostic-cron-analysis/SKILL.md` for wp-cron event analysis. Model structure on `skills/diagnostic-db-autoload/SKILL.md` (WP-CLI self-gating, JSON output format, error handling).

**Skill Identity (frontmatter):**
```yaml
---
name: diagnostic-cron-analysis
description: Analyzes WordPress wp-cron scheduled events for health issues including overdue events (>1 hour), duplicate hook registrations, and excessively frequent intervals (<5 minutes). Requires WP-CLI. Self-gates when WP-CLI is unavailable.
---
```

**Overview section:** WordPress wp-cron is pseudo-cron — events only fire when someone visits the site. Events can become overdue if traffic is low. Plugins sometimes register duplicate hooks or use intervals that are too frequent, causing unnecessary server load.

**Prerequisites:**
- `WP_CLI_AVAILABLE=true` and `WP_CLI_PREFIX` set — if not, return skip finding and stop
- Source type must NOT be `git` (no live DB)

**Self-gate:**
```bash
if [ "$WP_CLI_AVAILABLE" != "true" ]; then
  echo '[{"id":"PERF-CRON-SKIP","severity":"Info","category":"Performance","title":"Cron analysis skipped — WP-CLI not available","summary":"Cron event analysis requires WP-CLI to query the database.","detail":"WP_CLI_AVAILABLE is false. This check requires running wp cron event list which needs WP-CLI and a live WordPress database.","location":"wp-cron","fix":"Install WP-CLI on the server or connect via SSH or Docker source type with WP-CLI available."}]'
  exit 0
fi
```

**Data Collection:**
```bash
CRON_EVENTS=$($WP_CLI_PREFIX cron event list \
  --fields=hook,next_run_gmt,recurrence,interval,schedule \
  --format=json 2>/dev/null)

# Validate JSON response
if [ -z "$CRON_EVENTS" ] || ! echo "$CRON_EVENTS" | jq empty 2>/dev/null; then
  echo '[{"id":"PERF-CRON-ERR","severity":"Warning","category":"Performance","title":"Cron event list failed","summary":"Could not retrieve wp-cron events from the database.","detail":"wp cron event list returned empty or invalid output.","location":"wp-cron","fix":"Verify WP-CLI database access with: wp db check. Ensure the cron table is accessible."}]'
  exit 0
fi

# Get current UTC epoch for overdue comparison
CURRENT_EPOCH=$(date +%s)
```

**Check 1: Overdue Events (>1 hour = 3600 seconds past next_run_gmt):**

Convert `next_run_gmt` string to epoch. Handle macOS vs Linux date command difference:
```bash
# Cross-platform epoch conversion function
gmt_to_epoch() {
  local gmt_str="$1"
  # Try Linux date -d first, fall back to macOS date -j -f
  date -d "$gmt_str" +%s 2>/dev/null || \
  date -j -f "%Y-%m-%d %H:%M:%S" "$gmt_str" +%s 2>/dev/null || \
  echo "0"
}
```

Use jq to collect overdue events (next_run_gmt in past by >1 hour), then for each, call gmt_to_epoch and compare. Produce one finding per overdue event, or a single clean finding if none.

Finding ID for overdue: `PERF-CRON-OVRD` (fixed, not per-event hash — the hook name goes in detail).

Severity: Warning if overdue by 1-24 hours, Critical if overdue by >24 hours.

**Check 2: Duplicate Hooks (same hook name more than once):**

```bash
# Find hooks that appear more than once in the event list
DUPLICATES=$(echo "$CRON_EVENTS" | jq \
  '[group_by(.hook)[] | select(length > 1) | {hook: .[0].hook, count: length, events: .}]')
```

One finding per duplicate hook. Finding ID: `PERF-CRON-DUP`. Severity: Warning.

Example finding:
```json
{
  "id": "PERF-CRON-DUP",
  "severity": "Warning",
  "category": "Performance",
  "title": "Duplicate wp-cron hook: publish_future_post (3 instances)",
  "summary": "The same cron hook is registered multiple times, causing redundant executions.",
  "detail": "Hook 'publish_future_post' is registered 3 times in the cron table. This typically indicates a plugin that adds itself multiple times without deregistering first, or missed deregistration during plugin deactivation.",
  "location": "wp-cron",
  "fix": "Identify which plugin registers this hook (search codebase for wp_schedule_event with hook name 'publish_future_post'). Ensure the plugin deregisters existing events before registering new ones, and removes events on deactivation. Can manually clear via: wp cron event delete publish_future_post"
}
```

**Check 3: Excessive Frequency (interval < 300 seconds = 5 minutes):**

LOCKED decision: trigger on intervals under 5 minutes.

```bash
FREQUENT=$(echo "$CRON_EVENTS" | jq \
  '[.[] | select(.interval > 0 and .interval < 300)]')
```

One finding per frequent event. Finding ID: `PERF-CRON-FREQ`. Severity: Warning.

**Clean finding when no issues:**
```json
{
  "id": "PERF-CRON-OK",
  "severity": "Info",
  "category": "Performance",
  "title": "wp-cron schedule is healthy",
  "summary": "No overdue, duplicate, or excessively frequent cron events detected.",
  "detail": "Analyzed {COUNT} scheduled cron events. All events are on-schedule, unique, and use reasonable intervals.",
  "location": "wp-cron",
  "fix": "No action required."
}
```

**Error handling:** Follow same pattern as diagnostic-db-autoload — one error finding per failed check, not full abort.

**Note on non-repeating events:** Events with `interval: 0` or `recurrence: "Non-repeating"` should NOT be checked for excessive frequency (they only run once). The `interval < 300` check should only apply to recurring events (`interval > 0`).
  </action>
  <verify>Read skills/diagnostic-cron-analysis/SKILL.md and verify: (1) WP-CLI self-gate present, (2) overdue threshold is >1 hour (3600 seconds), (3) duplicate detection uses group_by(.hook), (4) frequency threshold is <300 seconds (5 minutes), (5) non-repeating events excluded from frequency check (interval > 0 condition), (6) macOS/Linux date fallback present, (7) finding IDs are PERF-CRON-OVRD, PERF-CRON-DUP, PERF-CRON-FREQ, PERF-CRON-OK.</verify>
  <done>skills/diagnostic-cron-analysis/SKILL.md exists with three checks (overdue/duplicate/frequency), cross-platform date handling, WP-CLI self-gating, and complete JSON output format with all required finding fields.</done>
</task>

<task type="auto">
  <name>Task 2: Create diagnostic-wpcli-profile SKILL.md</name>
  <files>skills/diagnostic-wpcli-profile/SKILL.md</files>
  <action>
Create `skills/diagnostic-wpcli-profile/SKILL.md` for WP-CLI Profile integration with two-stage degradation. This skill has a unique behavior: it asks the user before installing anything.

**Skill Identity (frontmatter):**
```yaml
---
name: diagnostic-wpcli-profile
description: Integrates WP-CLI Profile command (wp-cli/profile-command package) for runtime performance timing. Shows stage breakdown (bootstrap/main_query/template) and top 5 slowest hooks. When the profile package is not installed, produces itemized Info findings for each skipped check and offers to install.
---
```

**Overview section:** `wp-cli/profile-command` is a separately-installable WP-CLI package (not part of WP-CLI core) that measures actual PHP execution time by stage and hook. It reveals which plugins and callbacks are consuming the most time during WordPress bootstrap. Two stages of gating: WP-CLI must be available, then profile-command must be installed.

**Stage 1 Gate — WP-CLI availability:**
```bash
if [ "$WP_CLI_AVAILABLE" != "true" ]; then
  # Emit two skip findings (one per check that would have run)
  echo '[
    {"id":"PERF-PROF-STAGE-SKIP","severity":"Info","category":"Performance","title":"Stage profiling skipped — WP-CLI not available","summary":"Stage profiling requires WP-CLI and wp-cli/profile-command to run.","detail":"WP_CLI_AVAILABLE is false for this source type. Cannot check for wp-cli/profile-command without WP-CLI.","location":"wp profile stage","fix":"Install WP-CLI on the server to enable performance profiling."},
    {"id":"PERF-PROF-HOOK-SKIP","severity":"Info","category":"Performance","title":"Hook timing skipped — WP-CLI not available","summary":"Hook timing requires WP-CLI and wp-cli/profile-command to run.","detail":"WP_CLI_AVAILABLE is false. Cannot run wp profile stage bootstrap for hook timing.","location":"wp profile hook","fix":"Install WP-CLI on the server to enable hook timing analysis."}
  ]'
  exit 0
fi
```

**Stage 2 Gate — Profile command availability:**
```bash
# Check if wp-cli/profile-command is installed
$WP_CLI_PREFIX profile --help > /dev/null 2>&1
PROFILE_AVAILABLE=$?

if [ $PROFILE_AVAILABLE -ne 0 ]; then
  # LOCKED decision: offer to install, never auto-install
  echo "wp-cli/profile-command is not installed on the connected site."
  echo ""
  echo "This package enables stage profiling (bootstrap/main_query/template timing)"
  echo "and hook timing analysis (top 5 slowest callbacks in bootstrap)."
  echo ""
  echo "Install it now? (yes/no)"

  # Read user response
  # If user says yes:
  #   $WP_CLI_PREFIX package install wp-cli/profile-command:@stable
  #   Then re-check: $WP_CLI_PREFIX profile --help exit code
  #   If install succeeded, proceed with profiling below
  #   If install failed, emit skip findings with install error in detail
  # If user says no (or anything other than "yes"):
  #   Emit itemized skip findings (PERF-PROF-STAGE-SKIP, PERF-PROF-HOOK-SKIP) and exit

  # Skip findings when not installing:
  # (same structure as Stage 1 skip but with different detail/fix message)
  # Fix: "Install wp-cli/profile-command for hook timing: wp package install wp-cli/profile-command:@stable"
fi
```

**Profiling Execution (when profile-command is available):**

**Step A — Stage timing:**
```bash
STAGE_DATA=$($WP_CLI_PREFIX profile stage --format=json 2>/dev/null)

# CRITICAL: stages are named "bootstrap", "main_query", "template"
# NOT WordPress hook names like "plugins_loaded", "init", etc.
# The bootstrap stage CONTAINS plugins_loaded, init, wp_loaded — explain this to user in output

# Time is returned as string "0.7994s" — strip "s" for comparison
# Warning threshold (Claude's discretion): bootstrap > 2.0s
# Critical threshold: bootstrap > 5.0s
```

Parse each stage. For bootstrap time exceeding threshold, produce a Warning/Critical finding. Always produce one Info finding summarizing all three stages regardless of thresholds.

Finding ID: `PERF-PROF-STAGE`. Single finding with all three stages in detail.

Example finding detail:
```
Stage timing results:
  bootstrap:   0.7994s (93.21% cache ratio)  — covers plugins_loaded, init, wp_loaded
  main_query:  0.0234s (97.81% cache ratio)
  template:    0.1205s (91.45% cache ratio)

Total load time: 0.9433s
```

Severity thresholds for bootstrap (Claude's discretion):
- Info: bootstrap <= 2.0s
- Warning: bootstrap > 2.0s
- Critical: bootstrap > 5.0s

**Step B — Top 5 slowest hooks in bootstrap:**
```bash
HOOK_DATA=$($WP_CLI_PREFIX profile stage bootstrap \
  --fields=hook,time,cache_ratio \
  --spotlight \
  --format=json 2>/dev/null)

# spotlight flag returns only hooks with measurable time (not the full list)
# Sort by time descending, take top 5
TOP_HOOKS=$(echo "$HOOK_DATA" | jq '[sort_by(.time) | reverse | .[0:5]]')
```

Finding ID: `PERF-PROF-HOOK`. Single finding listing top 5 hooks with times.

Example finding detail:
```
Top 5 slowest hooks in bootstrap stage:
  1. plugins_loaded     0.2340s
  2. init               0.1823s
  3. wp_loaded          0.0934s
  4. after_setup_theme  0.0234s
  5. widgets_init       0.0123s
```

For each hook exceeding 0.5s: severity Warning. If all under 0.5s: severity Info.

**Finding format:** All findings use standard 8-field format (id/severity/category/title/summary/detail/location/fix). Category: `"Performance"`.

**Itemized skip findings (LOCKED — each skipped check is its own finding):**
```json
{
  "id": "PERF-PROF-STAGE-SKIP",
  "severity": "Info",
  "category": "Performance",
  "title": "Stage profiling skipped — wp-cli/profile-command not installed",
  "summary": "Stage profiling (bootstrap/main_query/template timing) requires the wp-cli/profile-command package.",
  "detail": "The wp-cli/profile-command package is not installed. Stage profiling measures how long each WordPress load stage takes, helping identify slow plugin initialization.",
  "location": "wp profile stage",
  "fix": "Install wp-cli/profile-command for stage timing: wp package install wp-cli/profile-command:@stable"
}
```
```json
{
  "id": "PERF-PROF-HOOK-SKIP",
  "severity": "Info",
  "category": "Performance",
  "title": "Hook timing skipped — wp-cli/profile-command not installed",
  "summary": "Hook timing analysis (top 5 slowest callbacks) requires the wp-cli/profile-command package.",
  "detail": "The wp-cli/profile-command package is not installed. Hook timing shows which specific callbacks in the bootstrap stage are slowest.",
  "location": "wp profile stage bootstrap --spotlight",
  "fix": "Install wp-cli/profile-command for hook timing: wp package install wp-cli/profile-command:@stable"
}
```

**Implementation note on time string parsing:** `wp profile stage` returns time as "0.7994s" (string). To compare numerically in jq: `gsub("s";"") | tonumber`. Apply this in jq filter before threshold comparison.
  </action>
  <verify>Read skills/diagnostic-wpcli-profile/SKILL.md and verify: (1) two-stage gate: WP-CLI check then profile --help check, (2) offer-to-install prompt present and never-auto-install pattern explicit, (3) stage names are "bootstrap", "main_query", "template" (NOT WordPress hook names), (4) bootstrap stage description explains it covers plugins_loaded/init/wp_loaded internally, (5) exactly two skip findings: PERF-PROF-STAGE-SKIP and PERF-PROF-HOOK-SKIP, (6) top 5 hooks from --spotlight flag on bootstrap stage, (7) time string parsing strips trailing "s" for numeric comparison.</verify>
  <done>skills/diagnostic-wpcli-profile/SKILL.md exists with two-stage gating, offer-to-install flow, stage timing (bootstrap/main_query/template), top-5 hook analysis, itemized skip findings for each missed check, and correct WP-CLI Profile stage names.</done>
</task>

</tasks>

<verification>
1. skills/diagnostic-cron-analysis/SKILL.md exists with three checks: overdue (>1hr), duplicate (same hook), excessive frequency (<5min)
2. Cron skill cross-platform date handling present (Linux date -d fallback to macOS date -j -f)
3. Non-repeating events (interval=0) excluded from frequency check
4. skills/diagnostic-wpcli-profile/SKILL.md exists with two-stage gating (WP-CLI then profile-command)
5. Profile skill: offer-to-install is interactive prompt, never automatic
6. Profile skill: stage names are "bootstrap", "main_query", "template" (not WordPress hook names)
7. Profile skill: exactly PERF-PROF-STAGE-SKIP and PERF-PROF-HOOK-SKIP findings (not a single generic skip)
8. Both skills use WP_CLI_PREFIX for all WP-CLI invocations
9. Both skills return findings as JSON arrays with all 8 standard fields
</verification>

<success_criteria>
Both skills exist as complete specifications. The cron analysis skill covers the three LOCKED triggers (overdue/duplicate/frequent). The WP-CLI profile skill implements the LOCKED two-stage degradation with itemized skip findings and user-prompt-before-install behavior.
</success_criteria>

<output>
After completion, create `.planning/phases/07-performance-architecture/07-02-SUMMARY.md`
</output>
