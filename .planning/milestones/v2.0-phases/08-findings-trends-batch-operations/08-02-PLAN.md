---
phase: 08-findings-trends-batch-operations
plan: 02
type: execute
wave: 2
depends_on:
  - 08-01
files_modified:
  - commands/batch/COMMAND.md
autonomous: true
requirements:
  - BTCH-01
  - BTCH-02

must_haves:
  truths:
    - "User can invoke /batch with site names as arguments and diagnostics run on each site sequentially"
    - "User can invoke /batch without arguments and be prompted to select from available sites"
    - "After each site completes, a status line shows: Site N/M: {name} ... Grade {X} ({N} critical, {N} warning) [{N}s]"
    - "After all sites complete, a comparison matrix displays all sites sorted by grade worst-first (F at top, A at bottom)"
    - "Comparison matrix columns: Site | Grade | Critical | Warning | Info | Last Scanned"
    - "Sites with incomplete scans show a coverage note in the matrix"
  artifacts:
    - path: "commands/batch/COMMAND.md"
      provides: "Multi-site batch diagnostic command with comparison matrix"
      contains: "Comparison Matrix"
  key_links:
    - from: "commands/batch/COMMAND.md"
      to: "commands/diagnose/COMMAND.md"
      via: "Sequential /diagnose invocation per site"
      pattern: "diagnose"
    - from: "commands/batch/COMMAND.md"
      to: "memory/{site}/trends.json"
      via: "Read grade, counts, and coverage from trends.json after each /diagnose"
      pattern: "trends\\.json"
    - from: "commands/batch/COMMAND.md"
      to: "sites.json"
      via: "List available sites for selection prompt"
      pattern: "sites\\.json"
---

<objective>
Create the /batch command that runs diagnostics across multiple saved site profiles sequentially and renders a comparison matrix sorted by health grade.

Purpose: Enable users to assess fleet health at a glance by running /diagnose on multiple sites in one operation and viewing a sorted comparison matrix of grades and finding counts.

Output: commands/batch/COMMAND.md (new)
</objective>

<execution_context>
@/Users/robertli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robertli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-findings-trends-batch-operations/08-RESEARCH.md
@.planning/phases/08-findings-trends-batch-operations/08-01-SUMMARY.md
@commands/diagnose/COMMAND.md
@sites.json.example
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create /batch command</name>
  <files>commands/batch/COMMAND.md</files>
  <action>
Create `commands/batch/COMMAND.md` following the same structural pattern as `commands/diagnose/COMMAND.md` (frontmatter with name/description/usage, sections with clear headings, bash code examples).

**Frontmatter:**
```yaml
---
name: batch
description: Run diagnostics across multiple saved site profiles sequentially with per-site status lines and a comparison matrix
usage: /batch [site1 site2 ...] [mode]
---
```

**Section 1: Argument Parsing**

Parse user input for site names and optional diagnostic mode:

- If site names provided as arguments: use those (e.g., `/batch mysite1 mysite2`)
- If no arguments (or just a mode keyword): list available sites from sites.json and prompt user to select
  - Show: "Available sites:" followed by `jq -r '.sites | keys[]' sites.json`
  - Accept space-separated site names or "all" for every configured site
- Mode detection: reuse same pattern as /diagnose (security-only, code-only, performance, full default). Mode keyword can appear anywhere in the argument list.
- Validate each requested site exists in sites.json. If a site is not found, print warning "Site '{name}' not found in sites.json — skipping" and continue with remaining sites.
- If no valid sites remain after validation, exit with message.

**Section 2: Sequential Execution**

For each site in the validated list, run /diagnose sequentially:

```
SITE_COUNT=${#SITES_TO_SCAN[@]}
SITE_NUM=0
RESULTS=()

for SITE_NAME in "${SITES_TO_SCAN[@]}"; do
  SITE_NUM=$((SITE_NUM + 1))
  START_TIME=$(date +%s)

  echo ""
  echo "━━━ Site $SITE_NUM/$SITE_COUNT: $SITE_NAME ━━━"

  # Follow commands/diagnose/COMMAND.md for this site with the selected MODE
  # /diagnose internally handles: reconnect, skill execution, report generation, trend tracking

  END_TIME=$(date +%s)
  ELAPSED=$((END_TIME - START_TIME))
```

After each /diagnose completes, read results from the generated artifacts:

- Read grade from `memory/${SITE_NAME}/trends.json` (field: `.current_scan.grade`)
- Read counts from trends.json (`.current_scan.critical_count`, `.current_scan.warning_count`, `.current_scan.info_count`)
- Read coverage from trends.json (`.current_scan.skill_coverage`)
- Read scan date from trends.json (`.current_scan.scan_date`)
- If trends.json doesn't exist (diagnose failed): set GRADE="ERR", counts to 0, coverage to "0/0"

Print status line:
```
echo "Site $SITE_NUM/$SITE_COUNT: $SITE_NAME ... Grade $GRADE ($CRITICAL critical, $WARNING warning) [${ELAPSED}s]"
```

Store result for matrix: `RESULTS+=("${SITE_NAME}|${GRADE}|${CRITICAL}|${WARNING}|${INFO}|${COVERAGE}|${SCAN_DATE}")`

Note in the COMMAND.md: "Sequential execution. Each site runs to completion before the next begins. This avoids SSH connection exhaustion and ensures each site's trends.json is written before the matrix reads it."

**Section 3: Comparison Matrix**

After all sites complete, render the comparison matrix sorted by grade worst-first:

Grade sort key mapping: F=0, D=1, C=2, B=3, A=4, Incomplete=5, ERR=9

```
echo ""
echo "═══════════════════════════════════════════════════════════════════"
echo "  Comparison Matrix"
echo "═══════════════════════════════════════════════════════════════════"
printf "%-25s %-6s %-10s %-10s %-6s %-12s\n" "Site" "Grade" "Critical" "Warning" "Info" "Last Scanned"
echo "───────────────────────────────────────────────────────────────────"
```

Sort results by grade sort key (numeric ascending = worst first):
- Build sortable lines with grade_sort_key prefix
- Pipe through `sort -t'|' -k1 -n`
- Print each row with printf alignment

After the table, add a coverage footnote for any sites where coverage is not "16/16" (or whatever the full skill count is):
```
# If any site has partial coverage, add footnote
echo ""
echo "Notes:"
echo "  * {site}: {coverage} skills (source: {source_type})"
```

Read source_type from sites.json for each site to provide context (e.g., "git: 8/16 skills").

Close the matrix with the bottom border.

**Section 4: Error Handling**

- If /diagnose fails for a site (connection error, all skills skipped): record ERR grade, show in status line as "Grade ERR (connection failed)", continue to next site
- If sites.json is missing or empty: exit with "No sites configured. Use /connect to add a site first."
- If user cancels during site selection prompt: exit gracefully

**Important notes to include in the COMMAND.md:**
- "This command runs /diagnose for each site. All /diagnose features apply: reconnect, source-type gating, trend tracking."
- "The comparison matrix reads from trends.json (written by trend-tracker during /diagnose). If a site's trends.json is missing, the matrix shows ERR."
- "Sites are scanned in the order provided. The matrix is sorted by grade regardless of scan order."
  </action>
  <verify>
File exists at commands/batch/COMMAND.md. Contains: frontmatter with name/description/usage, Section 1 (argument parsing with site validation and prompt), Section 2 (sequential execution with status lines), Section 3 (comparison matrix sorted worst-first), Section 4 (error handling). References sites.json for site listing and trends.json for result data.
  </verify>
  <done>
commands/batch/COMMAND.md exists as a complete command specification with: site selection (arguments or prompt), sequential /diagnose execution per site, per-site status lines with grade/counts/elapsed time, comparison matrix sorted by grade worst-first with coverage notes, and error handling for missing sites and failed diagnoses.
  </done>
</task>

<task type="auto">
  <name>Task 2: Register /batch in plugin manifest and update /status</name>
  <files>commands/batch/COMMAND.md</files>
  <action>
At the end of the /batch COMMAND.md, add a "Skill Registration" section (following the pattern used in other commands) that documents:

1. **Plugin manifest entry** — Add to `.claude-plugin/plugin.json` commands array:
   ```json
   {
     "name": "batch",
     "description": "Run diagnostics across multiple saved site profiles with comparison matrix",
     "path": "commands/batch/COMMAND.md"
   }
   ```

2. **Integration with /status** — The /status command's "Available Commands" footer (established in Phase 4) should include /batch:
   ```
   Available commands: /connect, /diagnose, /batch, /investigate, /status
   ```
   Note: This is a documentation reference — the /status COMMAND.md will need a one-line addition to its commands footer list. Add a note: "Update /status Available Commands footer to include /batch."

3. **Help text for /batch** — When user runs `/batch` with no arguments and no sites configured, show:
   ```
   Usage: /batch [site1 site2 ...] [mode]

   Run diagnostics across multiple sites and view a comparison matrix.

   Modes: full (default), security-only, code-only, performance

   Examples:
     /batch mysite1 mysite2          — Run full diagnostics on two sites
     /batch mysite1 security-only    — Run security scan on one site
     /batch                          — Prompted to select from available sites
   ```

This task is small and combined with Task 1 since they modify the same file. The manifest and /status updates are documentation notes within the COMMAND.md for the executor to follow.
  </action>
  <verify>
commands/batch/COMMAND.md contains: registration section with plugin.json entry, /status integration note, and help text examples.
  </verify>
  <done>
commands/batch/COMMAND.md includes registration documentation for plugin manifest, /status command update note, and user-facing help text with usage examples.
  </done>
</task>

</tasks>

<verification>
1. `commands/batch/COMMAND.md` exists with proper frontmatter and 4 sections
2. Site selection supports both argument-based and prompt-based workflows
3. Sequential execution runs /diagnose per site with timing
4. Status line format matches spec: "Site N/M: {name} ... Grade {X} ({N} critical, {N} warning) [{N}s]"
5. Comparison matrix columns: Site | Grade | Critical | Warning | Info | Last Scanned
6. Matrix sorted by grade worst-first (F=0 at top, A=4 at bottom)
7. Coverage notes appear for sites with partial skill coverage
8. ERR handling for failed sites (shown in matrix, doesn't stop batch)
9. Plugin manifest registration documented
</verification>

<success_criteria>
- /batch command is a complete, self-contained command specification following COMMAND.md patterns
- Comparison matrix reads from trends.json (created by Plan 08-01's trend-tracker)
- User can run `/batch site1 site2` or `/batch` with prompt for site selection
- Matrix provides at-a-glance fleet health assessment sorted by urgency (worst grade first)
</success_criteria>

<output>
After completion, create `.planning/phases/08-findings-trends-batch-operations/08-02-SUMMARY.md`
</output>
