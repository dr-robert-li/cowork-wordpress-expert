---
phase: 03-diagnostic-skills-reporting
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - skills/diagnostic-code-quality/SKILL.md
autonomous: true

must_haves:
  truths:
    - "Plugin performs AI-powered code quality analysis detecting anti-patterns and deprecated functions with file:line references"
    - "Plugin applies WordPress coding standards knowledge to identify code quality issues"
    - "Analysis targets active theme + custom plugins only; WP.org plugins get version check only"
    - "Analysis uses tiered approach: quick pattern scan all files, deep AI analysis on flagged files only"
  artifacts:
    - path: "skills/diagnostic-code-quality/SKILL.md"
      provides: "AI-powered code quality analysis with tiered scanning approach"
      min_lines: 150
  key_links:
    - from: "skills/diagnostic-code-quality/SKILL.md"
      to: "local synced files"
      via: "grep for pattern scan, Read for AI analysis"
      pattern: "grep.*\\$_GET|deprecated|wpdb.*query"
    - from: "skills/diagnostic-code-quality/SKILL.md"
      to: "WP-CLI active theme detection"
      via: "SSH to determine scan targets"
      pattern: "wp option get template"
---

<objective>
Rewrite the code quality diagnostic skill as a comprehensive two-pass analysis prompt: quick pattern scan for known anti-patterns, then deep AI analysis on flagged files.

Purpose: This skill replaces the existing generic code-quality SKILL.md with a WordPress-specific, actionable diagnostic that provides file:line references, fix snippets, and both technical and non-technical explanations for every finding.

Output: One SKILL.md file that instructs Claude to perform tiered code quality analysis on custom WordPress code (active theme + non-WP.org plugins).
</objective>

<execution_context>
@/Users/robertli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robertli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-diagnostic-skills-reporting/03-CONTEXT.md
@.planning/phases/03-diagnostic-skills-reporting/03-RESEARCH.md
@skills/code-quality/SKILL.md
@commands/connect/COMMAND.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite code quality skill with tiered analysis approach</name>
  <files>skills/diagnostic-code-quality/SKILL.md</files>
  <action>
Create a NEW skill at skills/diagnostic-code-quality/SKILL.md (this is a new directory, separate from the existing generic skills/code-quality/). The existing skills/code-quality/SKILL.md stays as-is -- it serves as general reference material. The new diagnostic skill is the actionable, structured version.

**skills/diagnostic-code-quality/SKILL.md** (DIAG-03, DIAG-04):
- YAML frontmatter: name "diagnostic-code-quality", description explaining it performs AI-powered code quality analysis on custom WordPress code using a two-pass tiered approach

The skill prompt must cover these sections:

**Section 1: Target Selection (per user decision)**
- Determine which code to analyze:
  1. Get active theme: `ssh {user}@{host} "cd {wp_path} && {wp_cli_path} option get template"` -- scan all PHP/JS files in this theme directory (locally at `.sites/{site-name}/wp-content/themes/{theme}/`)
  2. Get active stylesheet (child theme): `ssh {user}@{host} "cd {wp_path} && {wp_cli_path} option get stylesheet"` -- if different from template, scan the child theme too
  3. Identify custom plugins: For each plugin in `.sites/{site-name}/wp-content/plugins/`, check if it's a WP.org plugin using this heuristic:
     - Check if `readme.txt` exists with "Stable tag:" AND verify the slug exists on WordPress.org: `curl -s "https://api.wordpress.org/plugins/info/1.2/?action=plugin_information&request[slug]={dirname}" | grep -q '"error"'`
     - If API returns error (plugin not found on WP.org) = custom plugin, DO full code analysis
     - If API returns plugin info = WP.org plugin, SKIP code analysis (version check handled by version-audit skill)
  4. List the selected scan targets before proceeding

**Section 2: Pass 1 -- Quick Pattern Scan (all target files)**
Instruct Claude to grep locally synced files for these anti-patterns:

a. **Deprecated WordPress functions** (Warning):
   - `mysql_query`, `mysql_connect`, `mysql_real_escape_string` (removed in PHP 7+)
   - `get_bloginfo('url')` (use `home_url()`)
   - `wp_specialchars` (use `esc_html()`)
   - `get_settings` (use `get_option()`)
   - `create_function` (use closures)
   - `each()` (use foreach)
   Pattern: `grep -rn -E "(mysql_query|mysql_connect|mysql_real_escape_string|get_bloginfo\s*\(\s*['\"]url|wp_specialchars|get_settings\s*\(|create_function|[^a-z]each\s*\()" {target_dir} --include="*.php"`

b. **SQL injection risks** (Critical):
   - `$wpdb->query` without nearby `prepare()`: grep for `\$wpdb->query` then check context for missing prepare
   - Direct variable in SQL: `\$wpdb->get_results\s*\(\s*"` or `\$wpdb->get_row\s*\(\s*"` with `\$` inside the string
   Pattern: `grep -rn '\$wpdb->query\|\$wpdb->get_results\|\$wpdb->get_row\|\$wpdb->get_var' {target_dir} --include="*.php"`
   Then for each match, check if `prepare` appears within 3 lines

c. **Missing input sanitization** (Warning):
   - Direct `$_GET`, `$_POST`, `$_REQUEST` usage without `sanitize_*` or `esc_*` nearby
   Pattern: `grep -rn '\$_GET\[\|\$_POST\[\|\$_REQUEST\[' {target_dir} --include="*.php"`
   Then check context for sanitization functions

d. **Missing nonce verification** (Warning):
   - Form handlers processing `$_POST` without `wp_verify_nonce` or `check_ajax_referer`
   Pattern: Look for `$_POST` in functions registered to `wp_ajax_` hooks

e. **Hardcoded credentials/keys** (Critical):
   - Strings matching API key patterns, passwords in plain text
   Pattern: `grep -rn -E "(api_key|apikey|api_secret|password|secret_key)\s*=\s*['\"][^'\"]+['\"]" {target_dir} --include="*.php" --include="*.js"`

f. **extract() usage** (Warning):
   Pattern: `grep -rn "extract\s*(" {target_dir} --include="*.php"`

g. **Direct file includes with user input** (Critical):
   Pattern: `grep -rn -E "(include|require)(_once)?\s*\(.*\\\$_(GET|POST|REQUEST)" {target_dir} --include="*.php"`

For each pattern match: record file path, line number, matched content, pattern category.

**Section 3: Pass 2 -- Deep AI Analysis (flagged files only)**
For files with pattern matches from Pass 1:
1. Read the full file content
2. Analyze in context of WordPress coding standards:
   - Hook usage patterns (actions/filters registered correctly?)
   - Class structure and separation of concerns
   - Error handling (WP_Error usage, try/catch for external calls)
   - Proper enqueueing of scripts/styles (not hardcoded script tags)
   - Database operations (custom table creation with dbDelta, proper prefix usage)
3. Generate additional findings beyond what grep caught
4. For pattern matches from Pass 1, provide CONTEXT -- is the match actually a problem, or is it a false positive?

**Section 4: Finding Output Format**
Each finding must include:
- id: CODE-{CHECK_TYPE}-{3-char-md5-of-filepath:line} (e.g., CODE-SQLI-a3f, CODE-DEPR-b12)
- severity: Critical / Warning / Info
- category: "Code Quality"
- title: descriptive title
- summary: one non-technical sentence (per user decision)
- detail: technical explanation with the problematic code snippet
- location: "{file}:{line}"
- fix: the FIXED code snippet alongside the problematic one (per user decision: "Show problematic code AND suggested replacement")

**Example finding structure in the skill:**
```
Finding: CODE-SQLI-a3f
Severity: Critical
Title: SQL query without prepared statement
Summary: A database query is built using user-provided data without safety checks, which could allow attackers to manipulate the database.
Detail: `$wpdb->get_results("SELECT * FROM {$wpdb->posts} WHERE ID = {$_GET['id']}")` at wp-content/themes/custom/functions.php:142 passes user input directly into SQL without using $wpdb->prepare().
Location: wp-content/themes/custom/functions.php:142
Fix:
  Before: `$wpdb->get_results("SELECT * FROM {$wpdb->posts} WHERE ID = {$_GET['id']}")`
  After:  `$wpdb->get_results($wpdb->prepare("SELECT * FROM {$wpdb->posts} WHERE ID = %d", absint($_GET['id'])))`
```

Return all findings as JSON array.
  </action>
  <verify>
File exists at skills/diagnostic-code-quality/SKILL.md with YAML frontmatter. Skill covers: target selection (active theme + custom plugins, skip WP.org plugins), Pass 1 pattern scan (7 pattern categories), Pass 2 AI deep analysis, and finding output with before/after code snippets. Skill uses tiered approach (grep first, AI second). Original skills/code-quality/SKILL.md is untouched.
  </verify>
  <done>
skills/diagnostic-code-quality/SKILL.md exists with 150+ lines covering target selection per user decisions (active theme + custom plugins only), two-pass tiered analysis (pattern scan then AI analysis), 7 anti-pattern categories with grep commands, deep contextual AI analysis on flagged files, and findings with before/after fix snippets and file:line references.
  </done>
</task>

</tasks>

<verification>
Phase-level checks for this plan:
1. skills/diagnostic-code-quality/SKILL.md exists (new directory, separate from skills/code-quality/)
2. Valid YAML frontmatter with name and description
3. Target selection section references `wp option get template` and WordPress.org API for WP.org plugin detection
4. Pass 1 covers all 7 pattern categories: deprecated functions, SQL injection, missing sanitization, missing nonces, hardcoded credentials, extract(), file includes with user input
5. Pass 2 describes AI contextual analysis of flagged files
6. Findings include before/after code snippets (fix field)
7. Finding IDs use CODE-{TYPE}-{hash} format
8. Severity uses 3 levels: Critical, Warning, Info
9. Original skills/code-quality/SKILL.md is NOT modified
</verification>

<success_criteria>
One comprehensive code quality diagnostic skill created as a SKILL.md prompt implementing the tiered analysis approach: target selection (active theme + custom plugins per user decision), Pass 1 quick pattern scan with grep for 7 anti-pattern categories, Pass 2 deep AI analysis on flagged files, and structured findings with deterministic IDs, severity ratings, non-technical summaries, and before/after fix code snippets.
</success_criteria>

<output>
After completion, create `.planning/phases/03-diagnostic-skills-reporting/03-03-SUMMARY.md`
</output>
