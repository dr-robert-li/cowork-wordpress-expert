---
phase: 03-diagnostic-skills-reporting
plan: 04
type: execute
wave: 2
depends_on: ["03-01", "03-02", "03-03"]
files_modified:
  - skills/report-generator/SKILL.md
  - commands/status/COMMAND.md
  - .claude-plugin/plugin.json
autonomous: true

must_haves:
  truths:
    - "Findings are generated as structured markdown reports with severity ratings, technical details, and non-technical summaries"
    - "Reports include executive summary with letter grade (A-F) health score"
    - "Reports are stored in memory/{site-name}/ with latest.md and archive/"
    - "User can view health grade and finding summary inline in /status command"
  artifacts:
    - path: "skills/report-generator/SKILL.md"
      provides: "Report compilation, health grading, archiving, and markdown formatting"
      min_lines: 150
    - path: "commands/status/COMMAND.md"
      provides: "Updated /status with diagnostic summary inline display"
      min_lines: 400
    - path: ".claude-plugin/plugin.json"
      provides: "Updated plugin manifest with Phase 3 skills"
      contains: "1.2.0"
  key_links:
    - from: "skills/report-generator/SKILL.md"
      to: "memory/{site-name}/latest.md"
      via: "file write for report storage"
      pattern: "memory.*latest\\.md"
    - from: "skills/report-generator/SKILL.md"
      to: "diagnostic skill findings"
      via: "JSON array input from each skill"
      pattern: "findings.*JSON"
    - from: "commands/status/COMMAND.md"
      to: "memory/{site-name}/latest.md"
      via: "file read for inline summary"
      pattern: "memory.*latest\\.md"
---

<objective>
Create the report generator skill that compiles findings into structured markdown reports with health grades, and update the /status command to show diagnostic summaries inline.

Purpose: This plan connects all diagnostic skills into a complete reporting pipeline -- findings go in, graded reports come out, stored in memory/ for historical tracking, and visible via /status.

Output: Rewritten report-generator skill, updated /status command with diagnostic display, and updated plugin manifest.
</objective>

<execution_context>
@/Users/robertli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robertli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-diagnostic-skills-reporting/03-CONTEXT.md
@.planning/phases/03-diagnostic-skills-reporting/03-RESEARCH.md
@commands/status/COMMAND.md
@skills/reporting/SKILL.md
@.claude-plugin/plugin.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite report generator skill with health grading and archiving</name>
  <files>skills/report-generator/SKILL.md</files>
  <action>
Rewrite skills/report-generator/SKILL.md (replacing the existing generic reporting skill with the Phase 3 specific report generator). This is a NEW purpose-built skill, not an incremental edit.

**skills/report-generator/SKILL.md** (REPT-01, REPT-02, REPT-03):
- YAML frontmatter: name "report-generator", description explaining it compiles diagnostic findings into structured markdown reports with health grades and archives them

The skill prompt must cover these sections:

**Section 1: Input**
- Accepts findings from all diagnostic skills as JSON arrays
- Each finding has: id, severity, category, title, summary, detail, location, fix
- Categories expected: "Security" (from core-integrity, config-security, user-audit), "Code Quality" (from diagnostic-code-quality), "Version & Compatibility" (from version-audit), "Suspicious Code" (from malware-scan)

**Section 2: Health Grade Calculation (per user decision)**
Count findings by severity, then apply grading matrix:
- A: No critical findings AND 2 or fewer warnings
- B: No critical findings AND 3 or more warnings
- C: Exactly 1 critical finding OR 5+ warnings (with 0 critical)
- D: 2-3 critical findings
- F: 4 or more critical findings

Include the grade calculation logic explicitly so Claude can compute it deterministically.

**Section 3: Report Markdown Template (per user decision)**
Generate this exact structure:
```markdown
# WordPress Diagnostic Report: {site-name}
**Date:** {YYYY-MM-DD}
**Health Grade:** {A-F}
**Site:** {site-url}

## Executive Summary
{2-3 sentences: overall health assessment, critical finding count, top concern. Written for non-technical reader.}

### Finding Summary
| Severity | Count |
|----------|-------|
| Critical | {N}   |
| Warning  | {N}   |
| Info     | {N}   |

## Security Findings
{For each finding where category == "Security", sorted by severity (Critical first):}
### {finding.id}: {finding.title}
**Severity:** {finding.severity}
**Summary:** {finding.summary}
**Detail:** {finding.detail}
**Location:** {finding.location}
**Fix:** {finding.fix}

## Code Quality Findings
{Same structure for category == "Code Quality"}

## Version & Compatibility
{Same structure for category == "Version & Compatibility"}

## Suspicious Code
{Same structure for category == "Suspicious Code"}
{If no findings in a category, show "No issues found." under the heading}
```

Per user decision:
- 3-level severity only: Critical, Warning, Info
- Each finding has one-sentence non-technical summary (the "summary" field)
- Include fix snippets in each finding (the "fix" field)
- Executive summary is 2-3 sentences for non-technical reader

**Section 4: Archive Management (REPT-03)**
Before writing new report:
1. Check if `memory/{site-name}/latest.md` exists
2. If yes: move it to `memory/{site-name}/archive/scan-{YYYY-MM-DD}.md`
   - If same-day archive exists, append time: `scan-{YYYY-MM-DD}-{HHMMSS}.md`
3. Create directories if needed: `mkdir -p memory/{site-name}/archive`
4. Write new report to `memory/{site-name}/latest.md`

Provide the exact bash commands for archiving:
```bash
SITE_NAME="{site-name}"
MEMORY_DIR="memory/${SITE_NAME}"
LATEST="${MEMORY_DIR}/latest.md"
ARCHIVE_DIR="${MEMORY_DIR}/archive"

mkdir -p "$ARCHIVE_DIR"

if [ -f "$LATEST" ]; then
  TIMESTAMP=$(date +%Y-%m-%d)
  ARCHIVE_PATH="${ARCHIVE_DIR}/scan-${TIMESTAMP}.md"
  if [ -f "$ARCHIVE_PATH" ]; then
    TIMESTAMP=$(date +%Y-%m-%d-%H%M%S)
    ARCHIVE_PATH="${ARCHIVE_DIR}/scan-${TIMESTAMP}.md"
  fi
  mv "$LATEST" "$ARCHIVE_PATH"
fi
```

**Section 5: Finding ID Reference**
Document the ID format for cross-scan tracking:
- Security: SECR-{CHECK}-{hash} (from core-integrity, config-security, user-audit)
- Code Quality: CODE-{CHECK}-{hash} (from diagnostic-code-quality)
- Version: DIAG-{CHECK}-{hash} (from version-audit)
- Suspicious Code: SUSP-{CHECK}-{hash} (from malware-scan)
- Same issue in same location = same ID across scans (enables diff between reports)

Return: path to generated report file.
  </action>
  <verify>
File exists with YAML frontmatter. Contains health grade calculation matching user decision (A-F matrix). Report template has all 4 category sections (Security, Code Quality, Version & Compatibility, Suspicious Code). Archive management section has bash commands for latest.md rotation. Uses 3-level severity only. Each finding includes non-technical summary and fix snippet.
  </verify>
  <done>
skills/report-generator/SKILL.md exists with 150+ lines covering finding aggregation from all diagnostic skills, deterministic health grade calculation (A-F per user-defined matrix), structured markdown report generation with executive summary and 4 category sections, archive management with timestamp rotation, and finding ID cross-reference documentation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update /status command with diagnostic summary and plugin manifest</name>
  <files>commands/status/COMMAND.md, .claude-plugin/plugin.json</files>
  <action>
**Update commands/status/COMMAND.md** (REPT-04):

Read the existing file first. Add a new section to the site listing display (Step 3 of "Default Behavior: List All Sites") that shows diagnostic information inline when a report exists.

After the existing site info display (host, WordPress version, WP-CLI, last sync, local files, environment, notes), add diagnostic summary:

```bash
# Check for diagnostic report
REPORT_PATH="memory/${SITE_NAME}/latest.md"
if [ -f "$REPORT_PATH" ]; then
  # Extract health grade from report (first line matching "Health Grade:")
  HEALTH_GRADE=$(grep "^\*\*Health Grade:\*\*" "$REPORT_PATH" | sed 's/.*\*\*Health Grade:\*\* //')

  # Extract finding counts from summary table
  CRITICAL_COUNT=$(grep "| Critical |" "$REPORT_PATH" | sed 's/.*| //' | sed 's/ .*//' | tr -d ' ')
  WARNING_COUNT=$(grep "| Warning |" "$REPORT_PATH" | sed 's/.*| //' | sed 's/ .*//' | tr -d ' ')
  INFO_COUNT=$(grep "| Info |" "$REPORT_PATH" | sed 's/.*| //' | sed 's/ .*//' | tr -d ' ')

  # Extract scan date
  SCAN_DATE=$(grep "^\*\*Date:\*\*" "$REPORT_PATH" | sed 's/.*\*\*Date:\*\* //')

  # Extract top critical findings (up to 3)
  TOP_CRITICAL=$(grep -A 1 "^\*\*Severity:\*\* Critical" "$REPORT_PATH" | grep "^\*\*Summary:\*\*" | head -3 | sed 's/\*\*Summary:\*\* /  - /')

  echo "- **Health Grade:** $HEALTH_GRADE"
  echo "- **Last Scan:** $SCAN_DATE"
  echo "- **Findings:** $CRITICAL_COUNT critical, $WARNING_COUNT warning, $INFO_COUNT info"

  if [ -n "$TOP_CRITICAL" ]; then
    echo "- **Top Issues:**"
    echo "$TOP_CRITICAL"
  fi
else
  echo "- **Diagnostics:** No scan results yet. Run /diagnose to analyze."
fi
```

Also add a note in the command header about diagnostic display capability.

**Update .claude-plugin/plugin.json:**
- Bump version from 1.1.0 to 1.2.0 (Phase 3 completion)
- Add skills section listing all new diagnostic skills and their status:
  - diagnostic-core-integrity: implemented
  - diagnostic-config-security: implemented
  - diagnostic-user-audit: implemented
  - diagnostic-version-audit: implemented
  - diagnostic-malware-scan: implemented
  - diagnostic-code-quality: implemented
  - report-generator: implemented
- Update status command description to mention diagnostic summary display
  </action>
  <verify>
commands/status/COMMAND.md now includes diagnostic display section that reads from memory/{site-name}/latest.md. Shows health grade, finding counts, and top 3 critical issues. .claude-plugin/plugin.json has version 1.2.0 and lists all 7 new skills. Both files have valid structure.
  </verify>
  <done>
commands/status/COMMAND.md updated with inline diagnostic summary (health grade, finding counts, top critical issues from latest.md). .claude-plugin/plugin.json bumped to 1.2.0 with all 7 diagnostic skills registered. /status shows "No scan results yet" when no report exists.
  </done>
</task>

</tasks>

<verification>
Phase-level checks for this plan:
1. skills/report-generator/SKILL.md exists with health grade calculation and archive management
2. commands/status/COMMAND.md includes diagnostic summary display from memory/{site-name}/latest.md
3. .claude-plugin/plugin.json version is 1.2.0 with skills section
4. Report template has all 4 category sections
5. Health grade matrix matches user decision exactly (A-F thresholds)
6. Archive rotation handles same-day multiple scans
7. /status gracefully handles missing report (shows "no scan results" message)
</verification>

<success_criteria>
Report generator skill compiles findings from all diagnostic skills into structured markdown reports with letter-grade health scores, archives previous reports, and stores in memory/{site-name}/. /status command displays inline diagnostic summary (health grade, finding counts, top issues) for each connected site. Plugin manifest updated to v1.2.0 with all Phase 3 skills registered.
</success_criteria>

<output>
After completion, create `.planning/phases/03-diagnostic-skills-reporting/03-04-SUMMARY.md`
</output>
