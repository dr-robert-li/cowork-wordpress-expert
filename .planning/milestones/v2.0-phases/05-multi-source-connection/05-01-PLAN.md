---
phase: 05-multi-source-connection
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - commands/connect/COMMAND.md
autonomous: true
requirements:
  - MSRC-01
  - MSRC-02
  - MSRC-03
  - MSRC-04
  - MSRC-05
  - MSRC-07

must_haves:
  truths:
    - "/connect with no arguments shows a source type menu (SSH / Local / Docker / Git)"
    - "/connect with a local path validates WordPress markers and saves a profile with source_type local"
    - "/connect with a Docker container name probes for WordPress, detects bind mounts, and saves a profile with source_type docker"
    - "/connect with a git URL shallow-clones to .sites/ and saves a profile with source_type git"
    - "/connect with an existing local git checkout saves a profile with git metadata (remote, branch)"
    - "Existing SSH /connect flow is unchanged — backward compatible"
    - "sites.json profiles include source_type, container_name, git_remote, git_branch, file_access fields"
    - "Ambiguous input (bare token) asks user to clarify rather than guessing"
  artifacts:
    - path: "commands/connect/COMMAND.md"
      provides: "Multi-source /connect command with source detection, local/Docker/git/SSH flows"
      contains: "source_type"
  key_links:
    - from: "commands/connect/COMMAND.md"
      to: "sites.json"
      via: "jq atomic update with source_type and new profile fields"
      pattern: "source_type"
---

<objective>
Extend the /connect command to support four source types — SSH (existing), local directory, Docker container, and git repository — with auto-detection from user input and a menu fallback for ambiguous or empty input.

Purpose: Users need to connect to WordPress installations that are not remote SSH servers — local dev environments (MAMP, Flywheel), Docker containers, and git repositories for code review. This plan adds all four connection flows and the sites.json schema extension.

Output: Updated commands/connect/COMMAND.md with source type detection, four acquisition flows, and extended profile save logic.
</objective>

<execution_context>
@/Users/robertli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robertli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-multi-source-connection/05-RESEARCH.md
@.planning/phases/05-multi-source-connection/05-CONTEXT.md
@commands/connect/COMMAND.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add source type detection and local directory connection flow to /connect</name>
  <files>commands/connect/COMMAND.md</files>
  <action>
Restructure the /connect COMMAND.md to add source type routing at the top of the workflow, before any SSH-specific logic. The existing SSH flow (steps 1-9) must remain intact as one branch.

**Source type detection (new Section 0 — insert before existing Step 1):**

Add a new initial section "Section 0: Source Type Detection" that runs before anything else:

1. If /connect is called with no arguments, show a menu:
   ```
   What would you like to connect to?
     1) SSH — remote server via SSH
     2) Local — local WordPress directory
     3) Docker — WordPress in a Docker container
     4) Git — clone or point to a git repository
   Type the number or enter your target directly:
   ```

2. If an argument is provided, auto-detect source type using these rules (in order):
   - Starts with `https://`, `git@`, or `git://` → source type `git`
   - Starts with `/`, `./`, `../`, or `~` → source type `local` (but also check for `.git/` subdirectory — if found, ask: "This looks like a git repository. Connect as Git type (enables branch switching)? Or connect as Local type?")
   - Matches `user@host` pattern (contains `@` and no `/` path separator after the host) → source type `ssh`
   - Anything else (bare alphanumeric token) → **ambiguous**: show "This could be an SSH config alias or a Docker container name. Which is it? (ssh/docker)"

3. If user selected from menu: route to the appropriate flow below.

**Local directory flow (new Section — between detection and existing SSH):**

When source type is `local`:

1. Expand `~` to `$HOME` and resolve path via `realpath "$input_path" 2>/dev/null`
2. Validate WordPress markers (check all four, warn on partial):
   - `test -f "$wp_path/wp-config.php"` — wp-config.php present
   - `test -d "$wp_path/wp-includes/"` — wp-includes directory
   - `test -d "$wp_path/wp-admin/"` — wp-admin directory
   - `test -f "$wp_path/wp-load.php"` — wp-load.php present
   - If 0 markers found: "No WordPress installation detected at [path]. Expected wp-config.php, wp-includes/, wp-admin/." → abort
   - If 1-3 markers found: "Partial WordPress installation detected ([N]/4 markers). Missing: [list]. Some diagnostics may be limited. Continue? (y/n)"
   - If 4 markers found: proceed
3. For local source, `local_path` = `wp_path` (no copying needed)
4. Generate profile name from directory basename: `basename "$wp_path"` → lowercase, replace non-alphanumeric with hyphens
5. Ask user to confirm or customize the profile name
6. Probe for local WP-CLI: `which wp 2>/dev/null` — store path if found, null if not
7. If WP-CLI found and wp-config.php exists, try to read WP version: `wp core version --path="$wp_path" 2>/dev/null`
8. Try to read site_url: `wp option get siteurl --path="$wp_path" 2>/dev/null` (will fail if DB not accessible — that's OK)

**sites.json schema extension (modify existing profile save logic):**

Update the existing jq atomic write to include new fields for ALL source types. The save logic (already in the SSH flow) should be extended:

- `source_type` — "ssh", "local", "docker", or "git"
- `container_name` — Docker container name/ID, null for other types
- `git_remote` — git remote URL, null for non-git types
- `git_branch` — git branch name, null for non-git types
- `file_access` — "direct" (local, git), "rsync" (ssh), "bind_mount" (docker with bind), "docker_cp" (docker without bind)

For existing SSH profiles: add `source_type: "ssh"` and `file_access: "rsync"` to the SSH flow's save logic. Set container_name, git_remote, git_branch to null.

For reading source_type from existing profiles (backward compat): always use `jq -r '.source_type // "ssh"'`.

**Important:** Do NOT remove or alter the existing SSH flow logic (steps 1-9 in the current COMMAND.md). Wrap it in a conditional that runs when source_type is "ssh". The SSH flow continues to work exactly as before.
  </action>
  <verify>
Read the updated COMMAND.md and verify:
1. Section 0 (source detection) exists before any SSH logic
2. Local directory flow is complete with WP marker validation
3. sites.json save includes source_type, container_name, git_remote, git_branch, file_access fields
4. SSH flow is preserved intact within a source_type == "ssh" branch
5. Backward-compatible source_type read uses `// "ssh"` null-coalescing
  </verify>
  <done>
/connect with no arguments presents a 4-option source type menu. /connect with a local path validates WordPress markers and saves a profile with source_type "local". The SSH flow is unchanged. sites.json profiles include all new fields.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Docker container and git repository connection flows to /connect</name>
  <files>commands/connect/COMMAND.md</files>
  <action>
Add two new connection flow sections to COMMAND.md, parallel to the local flow from Task 1 and the existing SSH flow.

**Docker container flow (new section):**

When source type is `docker`:

1. If no container name/ID specified: list running containers using `docker ps --format "  {{.Names}} ({{.Image}})"` and ask user to select one.

2. Verify container is running: `docker inspect --format='{{.State.Status}}' "$container" 2>/dev/null`. If not "running", show: "Container '[name]' is not running (status: [status]). Start it first, then try again." → abort.

3. Probe for WordPress in known paths (in order):
   - /var/www/html
   - /app/public
   - /var/www
   - /var/www/wordpress
   - /usr/share/nginx/html
   - /srv/www

   For each: `docker exec "$container" test -f "$path/wp-config.php" 2>/dev/null`

   If none found: "WordPress not found in standard paths inside container. Enter the WordPress path inside the container:"

4. Detect bind mounts covering the WP path:
   ```bash
   docker inspect --format='{{json .Mounts}}' "$container" 2>/dev/null | \
     jq -r --arg path "$container_wp_path" \
     '.[] | select(.Type == "bind") | select($path | startswith(.Destination)) | .Source' | \
     head -1
   ```

   If bind mount found:
   - `local_path` = bind mount Source path on host
   - `file_access` = "bind_mount"
   - Tell user: "Using host bind mount at [path] — files are accessed directly, no copying needed."

   If no bind mount:
   - Generate site slug from container name
   - `local_path` = ".sites/[slug]/"
   - `mkdir -p "$local_path"`
   - Copy files: `docker cp "${container}:${wp_path}/." "$local_path"`
   - `file_access` = "docker_cp"
   - Tell user: "Copied WordPress files from container to [local_path]."

5. Probe WP-CLI inside container: `docker exec "$container" which wp 2>/dev/null` or `docker exec "$container" wp --version 2>/dev/null`. Store path if found.

6. If WP-CLI found inside container, read WP version and site_url via `docker exec "$container" wp core version --path="$wp_path"` and `docker exec "$container" wp option get siteurl --path="$wp_path"`.

7. Generate profile name from container name (lowercase, hyphenated). Ask user to confirm.

8. Save profile with source_type "docker", container_name, file_access, and other gathered data.

**Git repository flow (new section):**

When source type is `git`:

**Sub-flow A: Fresh clone from URL**

1. Extract site slug from URL: strip protocol/path prefix, remove `.git` suffix, lowercase, replace non-alphanumeric with hyphens.

2. List remote branches without cloning:
   ```bash
   default_branch=$(git ls-remote --symref "$git_url" HEAD 2>/dev/null | grep "^ref:" | sed 's|ref: refs/heads/||; s|\s.*||')
   default_branch="${default_branch:-main}"
   branch_count=$(git ls-remote --heads "$git_url" 2>/dev/null | wc -l)
   ```

   If multiple branches: "Repository has [N] branches. Using default: [branch]. Other branches: [list first 4]. Clone a different branch? (enter name or press Enter for default)"

3. Shallow clone: `git clone --depth 1 --branch "$branch" "$git_url" ".sites/$slug/"`. If clone fails (auth error, network), suggest checking SSH key (`ssh-add -l`) for git@ URLs or network connectivity for https URLs. Clean up failed clone directory.

4. `local_path` = ".sites/$slug/", `wp_path` = same. Validate WordPress markers (same check as local flow). Warn on partial — git repos may be theme-only or plugin-only.

5. WP-CLI: `which wp 2>/dev/null`. Store if found, but note: "Git sources have no live database. WP-CLI DB commands will not work."

6. Save profile with source_type "git", git_remote, git_branch, file_access "direct".

**Sub-flow B: Existing local checkout** (detected when input is a local path AND contains `.git/` directory, AND user chose "Git" type)

1. Resolve path with `realpath`. Set `local_path` = `wp_path` = resolved path.

2. Read git metadata: `git -C "$path" remote get-url origin 2>/dev/null` for git_remote, `git -C "$path" branch --show-current` for git_branch.

3. If multiple remote branches exist, mention them and offer to switch.

4. Validate WordPress markers (same as local flow).

5. Save profile with source_type "git", git_remote, git_branch, file_access "direct".

**Reconnect behavior for git profiles:**

When /connect is called with a profile name that already exists AND has source_type "git":
- Check if local_path still exists
- Ask: "Pull latest changes from origin/[branch]? (y/n)" — do NOT auto-pull per user decision
- If yes: `git -C "$local_path" pull origin "$git_branch"`
- If no: "Using existing local files."
- Update last_sync timestamp

**Important edge cases to document in the COMMAND.md:**
- Partial bind mounts (wp-content only): check both prefix directions in the jq filter. If only a subdirectory is mounted, fall back to docker cp.
- Docker container stopped between /connect and /diagnose: handled by diagnose (Plan 02), not here.
- Clone auth failures: provide actionable guidance, don't try to fix SSH keys automatically.
  </action>
  <verify>
Read the updated COMMAND.md and verify:
1. Docker flow includes container listing, WP path probing, bind mount detection with docker cp fallback, WP-CLI probe via docker exec
2. Git flow includes both fresh clone (--depth 1) and existing checkout sub-flows
3. Git reconnect asks whether to pull (not auto-pull)
4. Both flows save profiles with correct source_type and related fields
5. Edge cases documented (partial bind mounts, clone auth failures)
  </verify>
  <done>
/connect with a Docker container name validates the container, finds WordPress, detects bind mounts (or copies via docker cp), probes WP-CLI, and saves a Docker profile. /connect with a git URL performs a shallow clone and saves a git profile. /connect with a local git checkout detects the repo and stores git metadata. Reconnecting to a git profile asks before pulling.
  </done>
</task>

</tasks>

<verification>
1. Read commands/connect/COMMAND.md — verify all four source type flows exist (SSH, Local, Docker, Git)
2. Verify source detection logic matches locked decisions: / or . = local, git@ or https:// = git, user@host = ssh, ambiguous = ask
3. Verify /connect with no args shows the 4-option menu
4. Verify sites.json profile save includes source_type, container_name, git_remote, git_branch, file_access
5. Verify backward compatibility: existing SSH profiles without source_type default to "ssh" via `// "ssh"`
6. Verify Docker flow: container listing, WP path probe sequence, bind mount detection, docker cp fallback, docker exec WP-CLI probe
7. Verify Git flow: shallow clone, branch listing, existing checkout support, reconnect pull prompt
8. Verify local flow: multi-marker WP validation, partial match warning, local WP-CLI probe
</verification>

<success_criteria>
The /connect command handles SSH, local directory, Docker container, and git repository source types with auto-detection. Sites.json stores source_type per profile with backward-compatible defaults. All locked user decisions are honored.
</success_criteria>

<output>
After completion, create `.planning/phases/05-multi-source-connection/05-01-SUMMARY.md`
</output>
